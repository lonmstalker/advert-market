# Mini App API canary routing (edge).
#
# - Override cookie: `am_canary=1` forces canary, `am_canary=0` forces stable.
# - Otherwise, routing is sticky by `X-Canary-Key` (recommended: Telegram user.id).
# - If `X-Canary-Key` is missing, falls back to `remote_addr`.

map $cookie_am_canary $api_canary_force {
    default "";
    "1" "canary";
    "0" "stable";
}

map $http_x_canary_key $api_canary_seed {
    default $http_x_canary_key;
    "" $remote_addr;
}

# Generated by scripts/api-canary-set.sh (do not edit manually).
include /etc/nginx/canary-api-split.conf;

map $api_canary_force $api_canary_route {
    "canary" "canary";
    "stable" "stable";
    default $api_canary_split;
}

