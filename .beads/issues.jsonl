{"id":"advert-market-04t","title":"Frontend: Mini App Shell + Auth + Onboarding","description":"React 19 + TMA SDK интеграция, auth flow, onboarding screens.\n\n## Specs\n- .memory-bank/15-frontend-pages/01-onboarding.md\n- .memory-bank/17-typescript-conventions.md\n\n## Что реализовать\n\n### TMA SDK Integration\n- @tma.js/sdk-react: init, back button, main button, theme\n- initData extraction → POST /api/v1/auth/login\n- JWT storage (secure, httpOnly cookie or localStorage)\n- Auth context provider\n\n### Routing (React Router 7)\n- Protected routes wrapper\n- Navigation: BottomNavigation (Catalog, Deals, Wallet, Profile)\n\n### Onboarding (3 screens)\n- /onboarding/welcome — приветствие + выбор роли\n- /onboarding/interests — выбор категорий каналов\n- /onboarding/tour — быстрый тур по функциям\n- Skip/complete → redirect to catalog\n\n### API Client\n- Fetch wrapper с JWT Bearer header\n- Error handling (ProblemDetail → toast)\n- OpenAPI codegen (typescript-fetch)\n\n### Shared Components (уже начаты)\n- Button, Input (Storybook есть)\n- Расширить: Sheet, Modal, Toast, Skeleton, EmptyState\n\n## Подсказки\n- Telegram Mini App: window.Telegram.WebApp\n- Theme: CSS custom properties из TMA SDK\n- Зависит от: Auth Flow (backend)","status":"closed","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":360,"created_at":"2026-02-12T11:14:41.462013+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.278577+03:00","closed_at":"2026-02-12T21:17:52.278577+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["auth","frontend","onboarding"],"dependencies":[{"issue_id":"advert-market-04t","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:16:56.012455+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-0el","title":"Frontend: Catalog + Deal Pages","description":"Каталог каналов, детали канала, создание сделки, deal lifecycle UI.\n\n## Specs\n- .memory-bank/15-frontend-pages/02-catalog.md\n- .memory-bank/15-frontend-pages/03-deals.md\n\n## Что реализовать\n\n### Catalog Pages\n- /catalog — channel list + search/filters + infinite scroll\n- /catalog/:id — channel detail (stats, pricing, reviews)\n- /catalog/:id/deal — create deal form\n\n### Deal Pages\n- /deals — deal list (as advertiser/owner, tabs)\n- /deals/:id — deal detail + timeline\n- /deals/:id/negotiate — counter-offer form\n- /deals/:id/brief — creative brief form\n- /deals/:id/creative — creative draft viewer/editor\n- /deals/:id/review — creative review (approve/revise)\n- /deals/:id/schedule — scheduling confirmation\n- /deals/:id/payment — payment status + QR code\n- /deals/:id/dispute — dispute view/file\n\n### State Management\n- TanStack Query v5 для server state\n- Optimistic updates для transitions\n\n### Key Components\n- DealTimeline: визуализация state transitions\n- ChannelCard: preview в списке\n- PriceDisplay: форматирование nanoTON → TON\n- StatusBadge: цвет по DealStatus\n\n## Подсказки\n- TanStack Query: useQuery, useMutation, optimistic updates\n- Cursor pagination: useInfiniteQuery\n- Зависит от: Frontend Shell, Channel Service API, Deal State Machine API","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":480,"created_at":"2026-02-12T11:14:50.65223+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:14:50.65223+03:00","labels":["catalog","deals","frontend"],"dependencies":[{"issue_id":"advert-market-0el","depends_on_id":"advert-market-04t","type":"blocks","created_at":"2026-02-12T11:16:56.207448+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-0el","depends_on_id":"advert-market-6wx.1","type":"blocks","created_at":"2026-02-12T11:16:56.436249+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-0el","depends_on_id":"advert-market-6wx.2","type":"blocks","created_at":"2026-02-12T11:16:56.671893+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-0oz","title":"Acceptance Criteria","description":"- Migration tool chosen (Flyway recommended)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.505886+03:00","updated_at":"2026-02-11T01:36:35.443874+03:00","closed_at":"2026-02-11T01:36:35.443874+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-0pd","title":"Acceptance Criteria","description":"- Step-by-step MVP deployment guide","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.510729+03:00","updated_at":"2026-02-11T01:36:34.131318+03:00","closed_at":"2026-02-11T01:36:34.131318+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-0rw","title":"Unclaimed Payouts Handling (expiry + sweep)","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:39.35636+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:50:39.35636+03:00","labels":["financial","payouts","phase-3"],"dependencies":[{"issue_id":"advert-market-0rw","depends_on_id":"advert-market-av4","type":"blocks","created_at":"2026-02-12T11:51:24.272855+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-0zo","title":"Acceptance Criteria","description":"- Runnable SQL for each of 4 checks","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.508645+03:00","updated_at":"2026-02-11T01:36:34.779486+03:00","closed_at":"2026-02-11T01:36:34.779486+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-10m","title":"Acceptance Criteria","description":"- DLT naming convention and schema","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.509594+03:00","updated_at":"2026-02-11T01:36:34.489521+03:00","closed_at":"2026-02-11T01:36:34.489521+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-1lm","title":"PostgreSQL Sharding \u0026 Routing (Scaled)","description":"ShardedDslContextProvider: shard key routing algorithm (deal_id hash for financial, user_id for core), cross-shard queries, migration from single DB to 3 shards.","acceptance_criteria":"Routing algorithm with code; Cross-shard strategy; Migration procedure; Rebalancing strategy; jOOQ DSL routing","status":"closed","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:39:18.896658+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.374355+03:00","closed_at":"2026-02-11T02:32:56.374355+03:00","close_reason":"Implementation spec files created","labels":["database","postgresql","scaling"]}
{"id":"advert-market-1mt","title":"Worker Monitoring \u0026 DLQ Strategy","status":"open","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:23.810157+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:50:23.810157+03:00","labels":["dlq","kafka","monitoring","phase-4"],"dependencies":[{"issue_id":"advert-market-1mt","depends_on_id":"advert-market-tj7","type":"blocks","created_at":"2026-02-12T11:51:01.516679+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-20a","title":"Error Code Catalog","description":"Complete error enum: Auth (INVALID_INIT_DATA, SESSION_EXPIRED), Deal (INVALID_TRANSITION), Financial (INSUFFICIENT_BALANCE, ESCROW_ALREADY_FUNDED), Dispute, Team. Map to HTTP status codes, RFC 7807 format.","acceptance_criteria":"Error codes grouped by domain; HTTP status mapping; RFC 7807 examples; Developer-friendly messages; Enum class ready","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":45,"created_at":"2026-02-11T01:38:06.118087+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.513339+03:00","closed_at":"2026-02-11T02:32:42.513339+03:00","close_reason":"Implementation spec files created","labels":["api","error-handling"]}
{"id":"advert-market-2gd","title":"Notification Templates \u0026 i18n","description":"Message templates for 15 event types, template engine choice (Mustache/Thymeleaf), multi-language support (/language command), notification_outbox.payload JSONB schema.","acceptance_criteria":"Templates for 15 types; Template engine chosen; Multi-language architecture; Payload JSONB schema; Rendered examples","status":"closed","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":30,"created_at":"2026-02-11T01:39:18.658044+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.372037+03:00","closed_at":"2026-02-11T02:32:56.372037+03:00","close_reason":"Implementation spec files created","labels":["i18n","notifications","telegram"]}
{"id":"advert-market-2tk","title":"Acceptance Criteria","description":"- Spring Security filter chain configuration","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.50838+03:00","updated_at":"2026-02-11T01:36:34.857066+03:00","closed_at":"2026-02-11T01:36:34.857066+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-2tt","title":"Acceptance Criteria","description":"- Telegram Bot API methods for message verification","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.509364+03:00","updated_at":"2026-02-11T01:36:34.556197+03:00","closed_at":"2026-02-11T01:36:34.556197+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-2uo","title":"Acceptance Criteria","description":"- JSON Schema for creative_brief (all fields typed)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.510048+03:00","updated_at":"2026-02-11T01:36:34.348556+03:00","closed_at":"2026-02-11T01:36:34.348556+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-2xw","title":"Acceptance Criteria","description":"- All used endpoints documented with URL, method, headers","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.50665+03:00","updated_at":"2026-02-11T01:36:35.238914+03:00","closed_at":"2026-02-11T01:36:35.238914+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-339","title":"[C-6] BotExceptionHandler returns 200 for all webhook errors","description":"All exceptions → 200 OK. Combined with dedup failure, updates permanently lost. Return 5xx for unrecoverable.","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:32.784669+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.653331+03:00","closed_at":"2026-02-13T00:30:22.653331+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-33z","title":"[H-13] Missing @PropertyDoc on nested config records","description":"4 fields missing @PropertyDoc in TelegramBotProperties and TelegramResilienceProperties.","status":"closed","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:53.520023+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.682842+03:00","closed_at":"2026-02-13T00:30:22.682842+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-3c3","title":"Acceptance Criteria","description":"- Scheduler technology chosen","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.50982+03:00","updated_at":"2026-02-11T01:36:34.421535+03:00","closed_at":"2026-02-11T01:36:34.421535+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-3hs","title":"Worker Callback Payload Schemas (All 6 Types)","description":"JSON schemas for: DEPOSIT_CONFIRMED, PAYOUT_COMPLETED, REFUND_COMPLETED, PUBLICATION_RESULT, VERIFICATION_RESULT, RECONCILIATION_START. Retry policy, timeout, idempotency key format.","acceptance_criteria":"JSON schema for each of 6 types; Idempotency key algorithm per type; Retry policy; Timeout values; Error response handling","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:38:05.880254+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.510443+03:00","closed_at":"2026-02-11T02:32:42.510443+03:00","close_reason":"Implementation spec files created","labels":["api","schema","workers"],"dependencies":[{"issue_id":"advert-market-3hs","depends_on_id":"advert-market-3mw","type":"blocks","created_at":"2026-02-11T01:45:34.379987+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-3kk","title":"DDL Migration Scripts (Liquibase changesets)","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:02.27793+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:18:00.96519+03:00","closed_at":"2026-02-12T21:18:00.96519+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["database","migrations","phase-1"],"dependencies":[{"issue_id":"advert-market-3kk","depends_on_id":"advert-market-z8x","type":"blocks","created_at":"2026-02-12T11:50:52.175901+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-3mw","title":"Kafka Event Schemas for All 8 Topics","description":"Define complete event schemas (Avro or JSON Schema) for 8 Kafka topics: deal.events, escrow.commands, escrow.confirmations, delivery.commands, delivery.results, notifications.outbox, reconciliation.triggers, deal.deadlines. Serialization format choice, schema evolution rules.","acceptance_criteria":"Schema for each of 8 topics; Serialization format chosen; Schema evolution mode; Consumer deserialization error handling; Example producer/consumer code","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-11T01:37:14.254901+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.595294+03:00","closed_at":"2026-02-11T02:32:29.595294+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["infrastructure","kafka","schema"]}
{"id":"advert-market-3uu","title":"Delivery Verifier — Telegram API Details","description":"Telegram API calls for verification: getMessage by message_id, content hash comparison (SHA-256 text+media), partial edit detection, API failure retry, 24h retention timezone handling.","acceptance_criteria":"Telegram Bot API methods; Content hash algorithm; Partial edit logic; Retry with backoff; 24h timezone handling","status":"closed","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":45,"created_at":"2026-02-11T01:38:41.789671+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.366274+03:00","closed_at":"2026-02-11T02:32:56.366274+03:00","close_reason":"Implementation spec files created","labels":["delivery","telegram","workers"]}
{"id":"advert-market-3ww","title":"[H-1] Token blacklist silently fails on Redis error","description":"blacklist() catches DataAccessException, logs only. Logout succeeds but token remains valid.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:47.364876+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.680406+03:00","closed_at":"2026-02-13T00:30:22.680406+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-40c","title":"Deployment Runbook \u0026 Troubleshooting Guide","status":"open","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:15.116314+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:50:15.116314+03:00","labels":["cross-cutting","deployment","operations"]}
{"id":"advert-market-4bm","title":"Acceptance Criteria","description":"- initData HMAC validation code example","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.505372+03:00","updated_at":"2026-02-11T01:36:35.577072+03:00","closed_at":"2026-02-11T01:36:35.577072+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-4el","title":"Acceptance Criteria","description":"- Rounding rules documented with examples","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.511169+03:00","updated_at":"2026-02-11T01:36:33.981283+03:00","closed_at":"2026-02-11T01:36:33.981283+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-4fr","title":"Phase 5: Trust \u0026 Scale","description":"Dispute resolution, reconciliation, PII encryption, operator tooling. Trust and reliability.","design":"Modules: deal, financial, identity. Specs: 07, 14, 16","status":"open","priority":2,"issue_type":"epic","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T10:44:43.726266+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:44:43.726266+03:00","labels":["phase-5","trust"]}
{"id":"advert-market-4fr.1","title":"Dispute Auto-Resolution Engine","description":"Rules engine для автоматического разрешения споров + escalation к оператору.\n\n## Specs\n- .memory-bank/14-implementation-specs/16-dispute-auto-resolution.md\n- .memory-bank/03-feature-specs/06-dispute-resolution.md\n\n## Что реализовать\n\n### deal-api\n- DisputePort interface: openDispute(dealId, reason, evidence), resolveDispute(dealId, outcome, operatorNote)\n- DisputeOutcome enum: REFUND_FULL, PAYOUT, PARTIAL_REFUND, ESCALATE\n- DisputeReason enum: POST_DELETED, CONTENT_EDITED, CREATIVE_TIMEOUT, CHANNEL_RESTRICTED, OTHER\n- EvidenceType enum: POST_CHECK, TIMELINE, SCREENSHOT, TON_TX, CHANNEL_STATUS\n\n### deal-impl\n- DisputeResolutionEngine: evaluates rules in priority order\n- DisputeRule interface: matches(dispute, evidence) → boolean, outcome() → DisputeOutcome\n- Concrete rules (priority):\n  1. PostDeletedRule (10) → REFUND_FULL\n  2. ContentEditedRule (20) → REFUND_FULL\n  3. CreativeTimeoutRule (30) → REFUND_FULL\n  4. ChannelRestrictedRule (40) → REFUND_FULL\n  5. VerificationPassedRule (10) → PAYOUT\n  6. NoEvidenceRule (50, 48h) → PAYOUT\n  7. ConflictingEvidenceRule (60) → ESCALATE\n  8. HighValueRule (70, \u003e1000 TON) → ESCALATE\n  9. FallbackRule (999) → ESCALATE\n\n- DisputeEvidenceCollector: собирает evidence из delivery results, deal events, ton_transactions\n\n### REST API\n- POST /api/v1/deals/{id}/dispute — open dispute\n- POST /api/v1/deals/{id}/dispute/evidence — upload evidence\n- POST /api/v1/deals/{id}/dispute/resolve — operator resolution (admin only)\n- GET /api/v1/deals/{id}/dispute — dispute details\n\n### State Transitions\n- Any funded state → DISPUTED (either party)\n- DISPUTED → REFUNDED / COMPLETED_RELEASED / PARTIALLY_REFUNDED / ESCALATED\n\n## Подсказки\n- Strategy pattern: List\u003cDisputeRule\u003e sorted by priority\n- Зависит от: Deal workflow, Delivery verifier, Escrow\n- Partial refund (spec 42): time-based split","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T11:13:39.326997+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:13:39.326997+03:00","labels":["deal","disputes","phase-5"],"dependencies":[{"issue_id":"advert-market-4fr.1","depends_on_id":"advert-market-4fr","type":"parent-child","created_at":"2026-02-12T11:13:39.328345+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.1","depends_on_id":"advert-market-av4.5","type":"blocks","created_at":"2026-02-12T11:16:49.346145+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.1","depends_on_id":"advert-market-tj7.2","type":"blocks","created_at":"2026-02-12T11:16:49.450651+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-4fr.2","title":"Reconciliation Service (14 SQL Checks)","description":"Three-way reconciliation: ledger vs TON vs deals. 14 SQL checks.\n\n## Specs\n- .memory-bank/14-implementation-specs/14-reconciliation-sql.md\n- .memory-bank/07-financial-system/04-reconciliation.md\n\n## Что реализовать\n\n### financial-impl\n- ReconciliationService: orchestrates all checks\n- ReconciliationCheckRunner: executes individual SQL checks\n- ReconciliationReportGenerator: formats results\n\n### 14 Checks (by severity)\n**CRITICAL:**\n1. LedgerSelfBalanceCheck: SUM(debits) = SUM(credits) globally\n2. LedgerVsTonDepositsCheck: ledger deposits = confirmed on-chain\n5. PerTxBalanceCheck: every tx_ref balanced\n6. StuckSubwalletsCheck: terminal deals with on-chain balance \u003e dust\n11. OutboundTxVsLedgerCheck: every payout has withdrawal entry\n13. LateDepositCheck: LATE_DEPOSIT zeroed within 1h\n14. SeqnoConsistencyCheck: no stuck pending outbound TX \u003e 10min\n\n**HIGH:**\n3. LedgerVsDealsCheck: per-deal balance correct\n4. CqrsProjectionCheck: account_balances = recalculated (auto-fixable)\n7. NetworkFeesCheck: ledger fees = on-chain fees\n8. PartialDepositCheck: PARTIAL_DEPOSIT = on-chain for AWAITING_PAYMENT\n9. OverpaymentTimeoutCheck: zeroed within 24h\n\n**MEDIUM:**\n10. OwnerPendingCheck: zeroed within 30d\n12. CommissionSweepCheck: swept within 7d\n\n### Execution\n- @Scheduled daily 02:00 UTC\n- Manual: POST /api/v1/admin/reconciliation/run\n- Kafka: reconciliation.triggers topic\n\n### Alerting\n- CRITICAL failure → immediate notification\n- HIGH failure → 5min delay notification\n- Results stored in reconciliation_results table\n\n### Metrics\n- reconciliation.check{check, result=PASS|FAIL} (Counter)\n- reconciliation.duration (Timer)\n\n## Подсказки\n- jOOQ для complex aggregate queries\n- CqrsProjectionCheck can auto-fix: recalculate account_balances from ledger\n- Зависит от: Ledger, Escrow, TON SDK (on-chain queries)","notes":"ДОПОЛНЕНИЕ (найдено при аудите):\n- Reconciliation trigger producer: @Scheduled daily 02:00 UTC → produce to reconciliation.triggers topic\n- Не только consumer, но и self-triggering cron scheduler\n- Manual trigger: POST /api/v1/admin/reconciliation/run → produce trigger event","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":360,"created_at":"2026-02-12T11:13:47.458264+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:38:07.361466+03:00","labels":["financial","phase-5","reconciliation"],"dependencies":[{"issue_id":"advert-market-4fr.2","depends_on_id":"advert-market-4fr","type":"parent-child","created_at":"2026-02-12T11:13:47.461814+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.2","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:16:49.563207+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.2","depends_on_id":"advert-market-av4.3","type":"blocks","created_at":"2026-02-12T11:16:49.679713+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.2","depends_on_id":"advert-market-av4.4","type":"blocks","created_at":"2026-02-12T11:16:49.782501+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-4fr.3","title":"PII Encryption (Vault)","description":"Field-level AES-256-GCM encryption для TON addresses, phone numbers.\n\n## Specs\n- .memory-bank/14-implementation-specs/07-pii-encryption.md\n- .memory-bank/10-security-and-compliance.md\n\n## Что реализовать\n\n### identity-api (или shared)\n- PiiVaultPort interface: store(userId, fieldName, plaintext), retrieve(userId, fieldName) → String, delete(userId, fieldName), reEncrypt(userId, fieldName)\n\n### identity-impl\n- AesGcmEncryptionService: Java Cipher API\n  - AES/GCM/NoPadding, 256-bit key, 12-byte IV, 128-bit auth tag\n  - Output: IV (12) + ciphertext + tag (16) → BYTEA\n  - IV: SecureRandom, NEVER reuse (GCM catastrophic failure)\n\n- PiiKeyManager: key version registry\n  - MVP: env variable PII_ENCRYPTION_KEY (Base64 32-byte)\n  - Scaled: AWS KMS envelope encryption\n\n- PiiVaultService: implements PiiVaultPort\n  - store: encrypt → INSERT pii_store\n  - retrieve: SELECT → decrypt\n  - reEncrypt: decrypt with old key → encrypt with new key\n\n### Storage Schema\npii_store table: user_id, field_name(varchar 50), encrypted_value(BYTEA), key_version(int)\nFields: 'ton_address', 'phone'\n\n### Key Rotation\n1. New key version N+1\n2. New writes use N+1\n3. Background: re-encrypt key_version \u003c N+1\n4. Decommission old keys\n\n### Security Rules\n- NEVER cache decrypted values\n- NEVER log PII\n- NEVER store PII in Redis\n\n## Подсказки\n- javax.crypto.Cipher.getInstance(\"AES/GCM/NoPadding\")\n- GCMParameterSpec(128, iv) — 128-bit tag\n- Зависит от: Auth (user context)","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:13:57.463917+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:13:57.463917+03:00","labels":["identity","phase-5","security"],"dependencies":[{"issue_id":"advert-market-4fr.3","depends_on_id":"advert-market-4fr","type":"parent-child","created_at":"2026-02-12T11:13:57.4646+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.3","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:16:49.885772+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-4fr.4","title":"Partial Refund Accounting","description":"Time-based partial refund split при частичном выполнении сделки.\n\n## Specs\n- .memory-bank/14-implementation-specs/42-partial-refund-accounting.md\n\n## Что реализовать\n\n### financial-api (дополнение)\n- PartialRefundPort interface:\n  - calculateSplit(dealId, deliveredHours, totalHours) → RefundSplit\n- RefundSplit record: ownerPayoutNano, advertiserRefundNano, commissionNano, feeNano\n\n### financial-impl\n- PartialRefundService:\n  - Time-based split: ownerShare = dealAmount * deliveredHours / totalHours\n  - Commission на owner share only\n  - Refund остатка advertiser'у\n\n### Ledger Entries (PARTIALLY_REFUNDED state)\n```\nDEBIT  ESCROW:{deal_id}          1000 TON\nCREDIT OWNER_PENDING:{owner_id}   375 TON  (40% of 1000 * 0.9 commission)\nCREDIT COMMISSION:{deal_id}        42 TON  (10% of owner share, rounded)\nCREDIT EXTERNAL_TON               583 TON  (60% refund minus fee)\nCREDIT NETWORK_FEES              0.005 TON  (gas)\n```\n\n### Deal State\n- DISPUTED → PARTIALLY_REFUNDED (new terminal state)\n- Operator decision: sets deliveredHours (e.g., 10 out of 24)\n\n### Invariant\n- owner_payout + commission + refund + fee == deal_amount (exact)\n\n## Подсказки\n- Зависит от: Ledger (av4.1), Dispute Engine (4fr.1)\n- Floor rounding для commission, remainder к advertiser\n- Edge case: deliveredHours=0 → full refund, deliveredHours=24 → full payout","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T11:37:08.394717+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:37:08.394717+03:00","labels":["financial","phase-5","refund"],"dependencies":[{"issue_id":"advert-market-4fr.4","depends_on_id":"advert-market-4fr","type":"parent-child","created_at":"2026-02-12T11:37:08.395747+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.4","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:37:44.432972+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-4fr.4","depends_on_id":"advert-market-4fr.1","type":"blocks","created_at":"2026-02-12T11:37:44.661994+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-4iq","title":"TON SDK Integration Spec","description":"Choose SDK (ton-kotlin vs tonweb), document address generation (bounceable vs non-bounceable), transaction building for deposits/payouts/refunds, TON Center API endpoints (testnet/mainnet URLs, auth, rate limits), code examples for TON Payment Gateway.","acceptance_criteria":"SDK chosen with Maven/Gradle coords; Address generation example; TX submit example; TON Center API catalog; Testnet config","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-11T01:37:13.874925+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.591655+03:00","closed_at":"2026-02-11T02:32:29.591655+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["financial","integration","ton"]}
{"id":"advert-market-4k6","title":"Acceptance Criteria","description":"- Routing algorithm with code example","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.510951+03:00","updated_at":"2026-02-11T01:36:34.061118+03:00","closed_at":"2026-02-11T01:36:34.061118+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-5ge","title":"[Docs] Remove escaped Russian content from memory-bank","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-13T12:23:19.984568+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T12:23:40.323184+03:00","closed_at":"2026-02-13T12:23:40.323184+03:00","close_reason":"Closed"}
{"id":"advert-market-677","title":"[C-8] UpdateContext.userId() returns updateId as user ID fallback","description":"Returns update.updateId() when no user found. Collision with real user IDs. Return sentinel or Optional.","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:35.250686+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.651614+03:00","closed_at":"2026-02-13T00:30:22.651614+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-67w","title":"Acceptance Criteria","description":"- Complete rule catalog with conditions and outcomes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.509145+03:00","updated_at":"2026-02-11T01:36:34.624237+03:00","closed_at":"2026-02-11T01:36:34.624237+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-6lo","title":"[H-2] Blacklist TTL derived from config, not token exp","description":"After config change, blacklist entry can expire before token. Use actual token exp.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:47.472727+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.675123+03:00","closed_at":"2026-02-13T00:30:22.675123+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-6wx","title":"Phase 2: Marketplace Core","description":"Channel discovery, deal lifecycle, outbox, notifications. First user-facing features.","design":"Modules: marketplace-api, marketplace, deal-api, deal, communication. Specs: 11, 20, 22, 29, 35","status":"open","priority":1,"issue_type":"epic","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T10:44:21.845187+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:44:21.845187+03:00","labels":["marketplace","phase-2"]}
{"id":"advert-market-6wx.1","title":"Channel Service + Search","description":"CRUD каналов, динамический поиск с фильтрами, cursor pagination.\n\n## Specs\n- .memory-bank/14-implementation-specs/29-channel-search-impl.md\n- .memory-bank/03-feature-specs/01-channel-marketplace.md\n\n## Что реализовать\n\n### marketplace-api\n- ChannelPort interface: register, update, search, getById\n- ChannelDto record: id, title, description, topic, subscriberCount, priceNano, engagementRate, isActive\n- ChannelSearchCriteria record: topic, minSubscribers, maxSubscribers, minPrice, maxPrice, minEngagement, language, available, query, sort, cursor, limit\n- ChannelSort enum: RELEVANCE, SUBSCRIBERS_DESC/ASC, PRICE_ASC/DESC, ENGAGEMENT_DESC, UPDATED\n- PricingRuleDto record: channelId, name, postType, priceNano\n\n### marketplace-impl\n- ChannelService: бизнес-логика CRUD + валидация\n- ChannelSearchRepository: jOOQ dynamic query builder\n  - Full-text search через tsvector (GIN index)\n  - Keyset cursor pagination (Base64 JSON: sort_key + channel_id tie-breaker)\n  - Dynamic WHERE conditions (jOOQ Condition chaining)\n- PricingService: CRUD pricing rules per channel\n\n### REST API\n- GET /api/v1/channels — search with filters\n- GET /api/v1/channels/{id} — detail\n- POST /api/v1/channels — register (owner only)\n- PUT /api/v1/channels/{id} — update\n- GET/POST/PUT/DELETE /api/v1/channels/{id}/pricing — pricing rules\n\n### Indexes (DDL)\n- idx_channels_active_subscribers, idx_channels_active_price\n- idx_channels_tsv (GIN), idx_channels_topic, idx_channels_owner\n\n## Подсказки\n- jOOQ DSL: selectFrom(CHANNELS).where(conditions).orderBy(sortField).seekAfter(cursorValues).limit(limit+1)\n- tsvector: to_tsvector('russian', title || ' ' || description)\n- PostType enum: STANDARD, PINNED, STORY, REPOST, NATIVE, CUSTOM","status":"in_progress","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":360,"created_at":"2026-02-12T10:46:39.27178+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T01:38:28.719754+03:00","labels":["marketplace","phase-2","search"],"dependencies":[{"issue_id":"advert-market-6wx.1","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T10:46:39.272364+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.1","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:16:22.49197+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.1","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:16:22.597452+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.1","depends_on_id":"advert-market-z8x.6","type":"blocks","created_at":"2026-02-12T11:16:22.708711+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.10","title":"Team Management Service (channel_memberships CRUD)","description":"CRUD для channel_memberships: приглашение, изменение прав, удаление.\n\n## Specs\n- .memory-bank/03-feature-specs/07-team-management.md\n- .memory-bank/14-implementation-specs/13-abac-spring-security.md (channel_memberships model)\n\n## Предпосылки\nABAC (z8x.6) проверяет channel_memberships для авторизации, но CRUD для самих\nmemberships не реализован. Без этого owner не может приглашать менеджеров.\n\n## Что реализовать\n\n### identity-api\n- ChannelTeamPort interface:\n  - invite(channelId, userId, role, rights) → MembershipDto\n  - updateRights(channelId, userId, rights) → MembershipDto\n  - revoke(channelId, userId) → void\n  - listMembers(channelId) → List\u003cMembershipDto\u003e\n  - getMembership(channelId, userId) → MembershipDto\n- MembershipDto record: userId, channelId, role(OWNER/MANAGER), rights(ChannelRights), joinedAt\n- ChannelRights record: moderate(bool), publish(bool), manageTeam(bool), viewStats(bool)\n- ChannelRole enum: OWNER, MANAGER\n\n### identity-impl\n- ChannelTeamService:\n  - invite: INSERT channel_memberships, notify invitee\n  - updateRights: UPDATE channel_memberships.rights (JSONB)\n  - revoke: DELETE channel_memberships\n  - Validation: only OWNER or MANAGER with manage_team right can invite\n  - Owner cannot be removed/demoted\n  - Max 10 managers per channel\n\n### REST API\n- GET    /api/v1/channels/{id}/team — list members\n- POST   /api/v1/channels/{id}/team — invite member\n  - Body: { userId, role, rights }\n- PUT    /api/v1/channels/{id}/team/{userId} — update rights\n  - Body: { rights }\n- DELETE /api/v1/channels/{id}/team/{userId} — remove member\n\n### ABAC\n- @PreAuthorize(\"@channelAuth.hasRight(#channelId, 'manage_team')\")\n- Owner operations: @PreAuthorize(\"@channelAuth.isOwner(#channelId)\")\n\n### Notifications\n- TEAM_MEMBER_INVITED, TEAM_MEMBER_REMOVED templates\n\n## Подсказки\n- channel_memberships table уже в DDL (001-init-schema.sql)\n- rights = JSONB {moderate, publish, manage_team, view_stats}\n- Зависит от: Auth (z8x.5), ABAC (z8x.6)","status":"open","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":240,"created_at":"2026-02-12T11:36:30.414776+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:36:30.414776+03:00","labels":["identity","phase-2","team"],"dependencies":[{"issue_id":"advert-market-6wx.10","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T11:36:30.415432+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.10","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:37:42.417647+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.10","depends_on_id":"advert-market-z8x.6","type":"blocks","created_at":"2026-02-12T11:37:42.637154+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.2","title":"Deal State Machine + Transition Service","description":"Core state machine с 16 состояниями, переходы с валидацией, optimistic locking.\n\n## Specs\n- .memory-bank/14-implementation-specs/35-deal-workflow-engine.md\n- .memory-bank/06-deal-state-machine.md\n- .memory-bank/05-patterns-and-decisions/04-state-machine.md\n\n## Что реализовать\n\n### deal-api\n- DealPort interface: create, transition, getById, listByUser\n- DealDto record: id, advertiserId, channelId, status, amountNano, commissionNano, createdAt, etc.\n- DealTransitionCommand record: dealId, targetStatus, actorId, actorType\n- DealCreatedEvent, DealStateChangedEvent records\n\n### deal-impl\n- DealTransitionService: core state machine logic\n  1. Validate: current status → target status (allowed transitions table)\n  2. Validate: actor has permission (ABAC check)\n  3. Optimistic lock: UPDATE deals SET status=?, version=version+1 WHERE id=? AND version=?\n  4. Append deal_events\n  5. Insert notification_outbox (transactional outbox)\n  6. Return DealStateChangedEvent\n\n- DealRepository (jOOQ): CRUD + optimistic locking\n- DealEventRepository (jOOQ): append-only insert\n\n### State Transition Table\nDRAFT → OFFER_PENDING (advertiser), OFFER_PENDING → ACCEPTED/REJECTED/NEGOTIATING (owner),\nNEGOTIATING → ACCEPTED/REJECTED (owner/advertiser), ACCEPTED → AWAITING_PAYMENT (system),\nAWAITING_PAYMENT → FUNDED (system/deposit watcher), FUNDED → CREATIVE_SUBMITTED (advertiser),\nCREATIVE_SUBMITTED → CREATIVE_APPROVED/REVISION_REQUESTED (owner),\nCREATIVE_APPROVED → SCHEDULED (system), SCHEDULED → PUBLISHED (system/post scheduler),\nPUBLISHED → DELIVERY_VERIFYING (system), DELIVERY_VERIFYING → COMPLETED_RELEASED/DISPUTED (system),\nAny funded state → DISPUTED (either party), DISPUTED → REFUNDED/COMPLETED_RELEASED/PARTIALLY_REFUNDED (operator/system)\nAny pre-funded → CANCELLED/EXPIRED (system/user)\n\n### REST API\n- POST /api/v1/deals — create offer\n- POST /api/v1/deals/{id}/transition — state transition\n- GET /api/v1/deals/{id} — detail\n- GET /api/v1/deals — list (as advertiser/owner)\n\n## Подсказки\n- version column для optimistic locking (jOOQ .set(DEALS.VERSION, DEALS.VERSION.plus(1)).where(DEALS.VERSION.eq(currentVersion)))\n- Все переходы — single DB transaction (deal + deal_events + outbox)\n- deal_events: append-only, trigger prevents UPDATE/DELETE","notes":"ДОПОЛНИТЕЛЬНЫЕ ENDPOINTS (найдены при аудите):\n- POST /api/v1/deals/{id}/negotiate — counter-offer (часть negotiation flow)\n- GET  /api/v1/deals/{id}/timeline — история событий из deal_events\n- GET  /api/v1/deals/{id}/deposit — адрес депозита + статус оплаты\n- GET  /api/v1/deals/{id}/escrow — статус escrow (balance, entries)","status":"open","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":480,"created_at":"2026-02-12T10:46:51.651992+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:38:01.852298+03:00","labels":["deal","phase-2","state-machine"],"dependencies":[{"issue_id":"advert-market-6wx.2","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T10:46:51.652617+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.2","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:16:22.822565+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.2","depends_on_id":"advert-market-z8x.3","type":"blocks","created_at":"2026-02-12T11:16:22.923176+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.2","depends_on_id":"advert-market-z8x.4","type":"blocks","created_at":"2026-02-12T11:16:23.029828+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.3","title":"Creative Brief \u0026 Draft (JSONB)","description":"JSONB schemas для creative_brief и creative_draft в deals.\n\n## Specs\n- .memory-bank/14-implementation-specs/20-creative-jsonb-schemas.md\n- .memory-bank/03-feature-specs/03-creative-workflow.md\n\n## Что реализовать\n\n### Records (deal-api)\n- CreativeBrief record: textRequirements(max 2000), targetAudience, tone(enum), requiredLinks(max 5), requiredMedia(max 10), forbiddenWords, additionalNotes\n- CreativeDraft record: text(max 4096), media(max 10), buttons(max 5), parseMode(HTML/Markdown), version(int), revisionNote(max 500)\n- Tone enum: FORMAL, CASUAL, HUMOROUS, INFORMATIVE, URGENT\n- MediaItem record: type(PHOTO/VIDEO/GIF/DOCUMENT), fileId, caption\n- ButtonItem record: text, url\n\n### Jackson JSONB Mapping (deal-impl)\n- @JsonProperty annotations на всех полях\n- jOOQ converter: JSONB ↔ CreativeBrief / CreativeDraft\n\n### Validation\n- Spring Validation: @NotBlank, @Size, @Valid на вложенных\n- Custom validators если нужно\n\n### REST API\n- POST /api/v1/deals/{id}/brief — submit brief (advertiser)\n- POST /api/v1/deals/{id}/draft — submit draft (owner)\n- POST /api/v1/deals/{id}/draft/approve — approve (advertiser)\n- POST /api/v1/deals/{id}/draft/revise — request revision (advertiser)\n\n### Version Tracking\n- creative_draft.version starts at 1, increments per revision\n- Previous versions stored in deal_events payload\n\n## Подсказки\n- jOOQ JSONB converter: Converter\u003cJSONB, CreativeBrief\u003e + Jackson ObjectMapper\n- Зависит от Deal State Machine (transitions: FUNDED → CREATIVE_SUBMITTED → CREATIVE_APPROVED)","notes":"ДОПОЛНИТЕЛЬНЫЕ ENDPOINTS (найдены при аудите):\n- GET  /api/v1/deals/{id}/brief — получить creative brief\n- GET  /api/v1/deals/{id}/creative — получить текущий draft\n- GET  /api/v1/deals/{id}/creative/history — история версий draft\n- POST /api/v1/deals/{id}/creative/revision — запрос ревизии с комментарием","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T10:47:06.167878+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:38:04.27932+03:00","labels":["creative","deal","phase-2"],"dependencies":[{"issue_id":"advert-market-6wx.3","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T10:47:06.168759+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.3","depends_on_id":"advert-market-6wx.2","type":"blocks","created_at":"2026-02-12T11:16:23.146267+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.4","title":"Outbox Poller","description":"Polling notification_outbox → Kafka с guaranteed delivery.\n\n## Specs\n- .memory-bank/14-implementation-specs/11-outbox-poller.md\n- .memory-bank/05-patterns-and-decisions/03-transactional-outbox.md\n\n## Что реализовать\n\n### OutboxPoller (communication-impl)\n- @Scheduled(fixedDelay = 500ms)\n- SQL: SELECT FROM notification_outbox WHERE status='PENDING' ORDER BY created_at LIMIT 50 FOR UPDATE SKIP LOCKED\n- Publish each to notifications.outbox Kafka topic\n- Update status: PENDING → PROCESSING → DELIVERED/FAILED\n- Max 3 retries с exponential backoff\n\n### OutboxRecord\n- id, deal_id, recipient_id, template, payload(JSONB), retry_count, status, created_at\n\n### Cleanup\n- Daily job: DELETE FROM notification_outbox WHERE status='DELIVERED' AND created_at \u003c now() - INTERVAL '7 days'\n\n### Distributed Lock\n- lock:outbox:poller (30s) — только один poller одновременно\n\n### Metrics\n- outbox.poll.count, outbox.records.processed, outbox.records.failed, outbox.poll.duration, outbox.lag\n\n### Configuration\n- OutboxPollerProperties record: interval(500ms), batch-size(50), max-retries(3), initial-backoff(1s)\n\n## Подсказки\n- FOR UPDATE SKIP LOCKED — конкурентные pollers не блокируют друг друга\n- KafkaTemplate.send() + callback для подтверждения\n- Зависит от: Kafka schemas, Redis locks","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T10:47:17.49514+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:47:17.49514+03:00","labels":["communication","outbox","phase-2"],"dependencies":[{"issue_id":"advert-market-6wx.4","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T10:47:17.495796+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.4","depends_on_id":"advert-market-z8x.3","type":"blocks","created_at":"2026-02-12T11:16:23.266758+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.4","depends_on_id":"advert-market-z8x.4","type":"blocks","created_at":"2026-02-12T11:16:23.384097+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.5","title":"Notification Templates \u0026 i18n","description":"MessageSource-based шаблоны уведомлений на ru/en.\n\n## Specs\n- .memory-bank/14-implementation-specs/22-notification-templates-i18n.md\n- .memory-bank/03-feature-specs/08-notifications.md\n\n## Что реализовать\n\n### Template Files (communication)\n- messages/notifications_ru.properties (15 шаблонов)\n- messages/notifications_en.properties\n- Ключи: notification.NEW_OFFER, OFFER_ACCEPTED, OFFER_REJECTED, ESCROW_FUNDED, CREATIVE_SUBMITTED, CREATIVE_APPROVED, REVISION_REQUESTED, PUBLISHED, DELIVERY_VERIFIED, PAYOUT_SENT, DISPUTE_OPENED, DISPUTE_RESOLVED, DEAL_EXPIRED, DEAL_CANCELLED, RECONCILIATION_ALERT\n\n### NotificationRenderer (communication-impl)\n- MessageSource.getMessage(template, args, locale)\n- Locale resolution: users.language_code → fallback ru\n- MarkdownV2 escaping через MarkdownV2Util (уже реализован)\n\n### Kafka Consumer (communication-impl)\n- Consume notifications.outbox topic\n- Render template → TelegramSender.send()\n- Ack after successful delivery\n\n### Configuration\n- spring.messages.basename=messages/notifications,messages/errors\n\n## Подсказки\n- MessageSource уже auto-configured в Spring Boot\n- Использовать placeholders: {0}, {1} (MessageFormat)\n- Зависит от: Outbox Poller, TelegramSender (уже есть)","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T10:47:27.726063+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:47:27.726063+03:00","labels":["communication","notifications","phase-2"],"dependencies":[{"issue_id":"advert-market-6wx.5","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T10:47:27.726682+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.5","depends_on_id":"advert-market-6wx.4","type":"blocks","created_at":"2026-02-12T11:16:23.504499+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.6","title":"Telegram Channel API Service (getChat, getChatMember, getChatAdministrators)","description":"Facade для Telegram API методов работы с каналами. Фундамент для верификации.\n\n## Предпосылки\nТекущий TelegramSender умеет только отправлять сообщения. Для регистрации каналов, \nверификации админов и мониторинга нужен отдельный сервис для Channel API методов.\n\n## Что реализовать\n\n### communication-api\n- TelegramChannelPort interface:\n  - getChat(channelId) → ChatInfo\n  - getChatMember(channelId, userId) → ChatMemberInfo\n  - getChatAdministrators(channelId) → List\u003cChatMemberInfo\u003e\n  - getChatMemberCount(channelId) → int\n  - ChatInfo record: id, title, username, type, description, subscriberCount\n  - ChatMemberInfo record: userId, status(CREATOR/ADMINISTRATOR/MEMBER/LEFT/KICKED), canPostMessages, canEditMessages, canDeleteMessages, canManageChat\n  - ChatMemberStatus enum: CREATOR, ADMINISTRATOR, MEMBER, RESTRICTED, LEFT, KICKED\n\n### communication-impl\n- TelegramChannelService implements TelegramChannelPort\n  - Использует pengrad TelegramBot: bot.execute(new GetChat(channelId))\n  - bot.execute(new GetChatMember(channelId, userId))\n  - bot.execute(new GetChatAdministrators(channelId))\n  - bot.execute(new GetChatMemberCount(channelId))\n\n### Resilience\n- Circuit breaker: то же что Telegram Bot (window 50, threshold 40%)\n- Rate limiter: 1 req/s к одному каналу (Redis)\n- Cache: getChat → Redis 5min, getChatAdministrators → Redis 15min\n- Fallback при circuit open: return cached, flag stale\n\n### Error Handling\n- 400 Bad Request (chat not found) → ChannelNotFoundException\n- 403 Forbidden (bot not member) → BotNotMemberException\n- 429 Rate limited → respect retry_after, exponential backoff\n\n## Подсказки\n- pengrad API: GetChat, GetChatMember, GetChatAdministrators, GetChatMemberCount\n- ChatMember.status() → \"creator\", \"administrator\", \"member\", \"left\", \"kicked\"\n- ChatMemberAdministrator.canPostMessages() → boolean\n- Зависит от: TelegramBotConfig (уже есть), Redis (кеш)","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:30:28.7608+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:59:11.337576+03:00","closed_at":"2026-02-13T00:59:11.337576+03:00","close_reason":"Полностью реализовано: TelegramChannelPort (API), TelegramChannelService (impl), RedisChannelCache, RedisChannelRateLimiter, тесты. Файлы в untracked — нужен коммит.","labels":["channel","communication","phase-2","telegram-api"],"dependencies":[{"issue_id":"advert-market-6wx.6","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T11:30:28.761516+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.6","depends_on_id":"advert-market-88r","type":"blocks","created_at":"2026-02-12T12:13:23.394162+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.7","title":"Channel Registration + Bot Admin Verification","description":"Серверная проверка что бот является admin канала при регистрации. \nВерификация ownership канала.\n\n## Предпосылки\nПри регистрации канала (POST /api/v1/channels) нужно:\n1. Проверить что канал существует\n2. Проверить что бот добавлен как admin с нужными правами\n3. Проверить что регистрирующий user — admin/creator канала\n4. Только после этого создавать listing\n\n## Specs\n- .memory-bank/03-feature-specs/01-channel-marketplace.md\n- .memory-bank/15-frontend-pages/05-profile.md (строки 115-200)\n\n## Что реализовать\n\n### marketplace-api\n- ChannelVerificationPort interface:\n  - verifyBotAdmin(channelId) → BotAdminStatus\n  - verifyOwnership(channelId, userId) → OwnershipStatus\n  - BotAdminStatus record: isAdmin, canPostMessages, canEditMessages, missingPermissions\n  - OwnershipStatus record: isOwner, isAdmin, role(CREATOR/ADMINISTRATOR)\n\n### marketplace-impl\n- ChannelVerificationService:\n  1. getChat(channelId) → проверить что канал существует и доступен\n  2. getChatMember(channelId, botId) → проверить status=administrator\n  3. Проверить права: can_post_messages=true (обязательно)\n  4. getChatMember(channelId, userId) → проверить что user — creator или administrator\n\n### Channel Registration Flow (marketplace-impl)\nChannelRegistrationService:\n1. validateChannel(channelUsername) → resolve to channelId\n2. verifyBotAdmin(channelId) → MUST be admin with can_post_messages\n3. verifyOwnership(channelId, userId) → MUST be creator or administrator\n4. Check uniqueness: channel not already registered\n5. INSERT INTO channels → return ChannelDto\n\n### Required Bot Permissions\n- can_post_messages: TRUE (для публикации рекламы) — ОБЯЗАТЕЛЬНО\n- can_edit_messages: TRUE (для исправлений) — желательно\n- НЕ нужны: can_delete_messages, can_restrict_members, can_promote_members\n\n### Error Codes (новые)\n- CHAN_BOT_NOT_MEMBER (403) — бот не добавлен в канал\n- CHAN_BOT_NOT_ADMIN (403) — бот member, но не admin\n- CHAN_BOT_INSUFFICIENT_RIGHTS (403) — бот admin, но нет can_post_messages\n- CHAN_USER_NOT_ADMIN (403) — пользователь не admin канала\n- CHAN_ALREADY_REGISTERED (409) — канал уже зарегистрирован\n\n### REST API\n- POST /api/v1/channels/verify — проверить канал перед регистрацией (UI step 1)\n  - Input: { channelUsername: \"@example\" }\n  - Output: { channelId, title, subscriberCount, botStatus, userStatus }\n- POST /api/v1/channels — зарегистрировать (UI step 2, после успешной verify)\n\n## Подсказки\n- Зависит от: Telegram Channel API Service, Auth Flow, ABAC\n- Ownership verification: getChatMember(channelId, requestUserId).status in (creator, administrator)\n- Для creator: ChatMember type = ChatMemberOwner (pengrad)\n- Bot self ID: bot.execute(new GetMe()).user().id()","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":240,"created_at":"2026-02-12T11:30:31.114641+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T01:25:25.332625+03:00","closed_at":"2026-02-13T01:25:25.332625+03:00","close_reason":"Implemented: verify + register endpoints, parallel Telegram API checks, 14 unit tests, all green","labels":["channel","marketplace","phase-2","verification"],"dependencies":[{"issue_id":"advert-market-6wx.7","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T11:30:31.115393+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.7","depends_on_id":"advert-market-6wx.6","type":"blocks","created_at":"2026-02-12T11:31:15.223149+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.7","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:31:15.330424+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.7","depends_on_id":"advert-market-z8x.6","type":"blocks","created_at":"2026-02-12T11:31:15.441785+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.7","depends_on_id":"advert-market-88r","type":"blocks","created_at":"2026-02-12T12:13:23.498573+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.8","title":"Bot Membership Monitoring (my_chat_member webhook)","description":"Обработка my_chat_member webhook updates: реагирование на добавление/удаление бота из канала.\n\n## Предпосылки\nTelegram отправляет my_chat_member update когда статус бота изменяется в чате.\nБез этого — деактивация каналов будет только ручной или по таймеру.\n\n## Что реализовать\n\n### Webhook Update (communication)\n1. Добавить \"my_chat_member\" в allowed_updates при setWebhook\n   - Текущий: [\"message\", \"callback_query\"]\n   - Новый: [\"message\", \"callback_query\", \"my_chat_member\"]\n\n2. Расширить BotDispatcher для обработки my_chat_member updates\n   - Новый handler type: MyChatMemberHandler interface\n   - UpdateContext: добавить myChatMember() accessor\n\n### MyChatMemberHandler (communication-impl)\n- BotChannelStatusHandler implements MyChatMemberHandler:\n  - Фильтр: только для каналов (chat.type = \"channel\")\n  - Логика по new_chat_member.status:\n\n  **Bot added as admin (member → administrator):**\n  - Если канал уже зарегистрирован: reactivate (is_active = true)\n  - Если не зарегистрирован: ignore (регистрация через API)\n  - Log: [CHANNEL] Bot added as admin to {channelId}\n\n  **Bot removed (administrator/member → left/kicked):**\n  - Деактивировать канал: UPDATE channels SET is_active=false WHERE telegram_id=?\n  - Уведомить owner: CHANNEL_BOT_REMOVED notification\n  - Если есть активные deals: alert operator\n  - Log: [CHANNEL] Bot removed from {channelId}\n\n  **Bot demoted (administrator → member):**\n  - Деактивировать: бот не может постить без admin прав\n  - Уведомить owner: CHANNEL_BOT_DEMOTED notification\n\n  **Bot rights changed:**\n  - Проверить can_post_messages\n  - Если false: деактивировать + уведомить\n  - Если true: reactivate\n\n### Notification Templates (новые)\n- notification.CHANNEL_BOT_REMOVED: \"Бот был удалён из канала {channel_title}. Канал деактивирован.\"\n- notification.CHANNEL_BOT_DEMOTED: \"Права бота изменены в канале {channel_title}. Добавьте бота как администратора.\"\n\n### Metrics\n- channel.bot.status.change{action=added|removed|demoted|rights_changed}\n- channel.deactivated.total{reason=bot_removed|bot_demoted|rights_changed}\n\n## Подсказки\n- pengrad: update.myChatMember() → ChatMemberUpdated\n- ChatMemberUpdated: chat(), from(), date(), oldChatMember(), newChatMember()\n- newChatMember().status() → \"administrator\", \"member\", \"left\", \"kicked\"\n- Зависит от: Channel Service (для update is_active), Notification Templates","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:30:43.421348+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:30:43.421348+03:00","labels":["communication","monitoring","phase-2","webhook"],"dependencies":[{"issue_id":"advert-market-6wx.8","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T11:30:43.421955+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.8","depends_on_id":"advert-market-6wx.6","type":"blocks","created_at":"2026-02-12T11:31:15.559759+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.8","depends_on_id":"advert-market-6wx.1","type":"blocks","created_at":"2026-02-12T11:31:15.662382+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.8","depends_on_id":"advert-market-88r","type":"blocks","created_at":"2026-02-12T12:13:23.614939+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6wx.9","title":"Pre-Deal Channel Verification","description":"Проверка статуса бота и канала перед созданием deal offer.\n\n## Предпосылки\nСценарий: owner зарегистрировал канал, потом удалил бота, но advertiser пытается \nсоздать deal. Без pre-check деньги уйдут в escrow, а опубликовать пост не получится.\n\n## Что реализовать\n\n### deal-impl (DealCreationService)\nПеред INSERT INTO deals добавить валидацию:\n1. Проверить channel.is_active = true\n2. Если последняя верификация \u003e 15 минут — force refresh:\n   - TelegramChannelPort.getChatMember(channelId, botId)\n   - Если бот не admin → деактивировать канал + reject deal\n3. Проверить что канал не заблокирован (disputes \u003e threshold)\n\n### Freshness Policy\n- channels.bot_verified_at TIMESTAMPTZ — время последней проверки\n- Если bot_verified_at \u003e now() - 15min → skip verification (use cached)\n- Если bot_verified_at \u003c now() - 15min → call Telegram API\n- Если Telegram API недоступен (circuit open) → разрешить deal, пометить \"unverified\"\n\n### DDL Extension\nALTER TABLE channels ADD COLUMN bot_verified_at TIMESTAMPTZ;\n\n### Error Codes (новые)\n- DEAL_CHANNEL_INACTIVE (400) — канал деактивирован\n- DEAL_CHANNEL_BOT_NOT_ADMIN (400) — бот не admin (обнаружено при pre-check)\n\n### Metrics\n- deal.creation.channel_check{result=PASS|FAIL_INACTIVE|FAIL_BOT|SKIP_CACHED|SKIP_UNAVAILABLE}\n\n## Подсказки\n- Зависит от: Channel Registration, Telegram Channel API, Deal State Machine\n- Fallback: если API недоступен, разрешить deal (не блокировать revenue)\n- Но деактивировать + alert если API вернул 403","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T11:30:55.347571+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:30:55.347571+03:00","labels":["channel","deal","phase-2","verification"],"dependencies":[{"issue_id":"advert-market-6wx.9","depends_on_id":"advert-market-6wx","type":"parent-child","created_at":"2026-02-12T11:30:55.348164+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.9","depends_on_id":"advert-market-6wx.6","type":"blocks","created_at":"2026-02-12T11:31:15.763319+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.9","depends_on_id":"advert-market-6wx.7","type":"blocks","created_at":"2026-02-12T11:31:15.876593+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6wx.9","depends_on_id":"advert-market-6wx.2","type":"blocks","created_at":"2026-02-12T11:31:15.999145+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6x8","title":"Confirmation Policy — TON Block Height Tracking","description":"TON Deposit Watcher block confirmation tracking: block height query via TON Center, confirmation counting, operator review workflow for \u003e1000 TON, amount validation (exact/over/under).","acceptance_criteria":"Block height query implementation; Counting algorithm; Operator review flow; Over/underpayment handling; Amount tolerance","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":45,"created_at":"2026-02-11T01:38:06.463636+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.516907+03:00","closed_at":"2026-02-11T02:32:42.516907+03:00","close_reason":"Implementation spec files created","labels":["confirmation","financial","ton"],"dependencies":[{"issue_id":"advert-market-6x8","depends_on_id":"advert-market-4iq","type":"blocks","created_at":"2026-02-11T01:45:34.166731+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-6x8","depends_on_id":"advert-market-uyo","type":"blocks","created_at":"2026-02-11T01:45:34.233238+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-6z7","title":"Acceptance Criteria","description":"- Block height query implementation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.508901+03:00","updated_at":"2026-02-11T01:36:34.699003+03:00","closed_at":"2026-02-11T01:36:34.699003+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-70s","title":"[H-5] Channel rate limiter result ignored","description":"rateLimiter.acquire() returns boolean but never checked. Rate limiting completely ineffective.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:47.816842+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.671382+03:00","closed_at":"2026-02-13T00:30:22.671382+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-73h","title":"[H-7] Swagger UI and internal endpoints publicly accessible","description":"/internal/v1/**, swagger all permitAll(). Restrict in production.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:48.058629+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.668919+03:00","closed_at":"2026-02-13T00:30:22.668919+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-7lx","title":"Creative library: CRUD + picker + deal attachment","description":"Библиотека креативов рекламодателя. Рекламодатель создаёт готовые посты (текст 4096, CTA-кнопки max 3, медиа max 5, заметки 500) и сохраняет в БД. При создании сделки выбирает существующий креатив или создаёт новый inline. Владелец канала может доработать креатив (натив). Scope: 1) feature/creatives (types, API, hooks, components) 2) /profile/creatives page (CRUD list) 3) Creative picker/creator in CreateDealPage 4) MSW handlers 5) i18n ru/en. Schema: creativeDraftSchema { text, buttons[], media[], notes }. createDealRequest добавляет creativeId | creative inline.","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-13T02:23:59.11171+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T02:23:59.11171+03:00"}
{"id":"advert-market-88r","title":"Telegram Bot Framework \u0026 Webhook Setup","description":"Implement core Telegram bot infrastructure: webhook registration, command router, callback query handling, message sending with retry, rate-limit compliance. Spec: .memory-bank/14-implementation-specs/02-telegram-bot-framework.md","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T12:12:45.444836+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.275478+03:00","closed_at":"2026-02-12T21:17:52.275478+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["bot","phase-1","telegram","webhook"],"dependencies":[{"issue_id":"advert-market-88r","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T12:13:27.172043+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-8gy","title":"[H-9] MarkdownV2 escape missing backslash","description":"Backslash not in escape pattern. Malformed MarkdownV2 possible.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:52.982326+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.666383+03:00","closed_at":"2026-02-13T00:30:22.666383+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-92g","title":"Reconciliation SQL Queries","description":"Production-ready SQL for 4 checks: ledger self-balance, ledger vs TON txs, ledger vs deal aggregates, CQRS projection consistency. Tolerance handling, time-range filtering, performance.","acceptance_criteria":"Runnable SQL for 4 checks; Time-range filtering; Tolerance thresholds; EXPLAIN ANALYZE; Alert severity per check","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:38:06.330086+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.515826+03:00","closed_at":"2026-02-11T02:32:42.515826+03:00","close_reason":"Implementation spec files created","labels":["database","financial","reconciliation"],"dependencies":[{"issue_id":"advert-market-92g","depends_on_id":"advert-market-9te","type":"blocks","created_at":"2026-02-11T01:46:05.968024+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-92t","title":"[C-5] OutboxPoller uses initialBackoff as publish timeout","description":"1s timeout too aggressive. orTimeout mutates publish future. Add separate publishTimeout property.","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:31.59047+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.654621+03:00","closed_at":"2026-02-13T00:30:22.654621+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-931","title":"[C-2] Webhook secret validation bypassed when empty","description":"Default secret is empty string. All webhooks accepted without auth. Add @NotBlank, fail-closed if empty.","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:28.021994+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.658652+03:00","closed_at":"2026-02-13T00:30:22.658652+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-946","title":"Deployment Runbook \u0026 Troubleshooting","description":"MVP deployment guide, health check endpoints, rollback procedure, common failure scenarios and remediation, financial incident escalation playbook.","acceptance_criteria":"Step-by-step deployment; Health checks list; Rollback per component; Top 10 failure scenarios; Financial incident escalation","status":"closed","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":45,"created_at":"2026-02-11T01:39:18.767211+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.373204+03:00","closed_at":"2026-02-11T02:32:56.373204+03:00","close_reason":"Implementation spec files created","labels":["deployment","devops","operations"]}
{"id":"advert-market-9e4","title":"PostgreSQL Partitioning \u0026 Sharding Strategy","description":"PostgreSQL partitioning/sharding strategy. Trigger: revisit when ledger_entries \u003e 10M rows or TPS \u003e 500. Spec: .memory-bank/14-implementation-specs/24-postgresql-sharding.md","status":"open","priority":4,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:20.737745+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T12:14:10.166196+03:00","defer_until":"2026-08-12T12:14:10+03:00","labels":["database","phase-5","scaling"],"dependencies":[{"issue_id":"advert-market-9e4","depends_on_id":"advert-market-4fr","type":"blocks","created_at":"2026-02-12T11:51:15.331477+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-9te","title":"Complete DDL Migration Scripts","description":"Runnable DDL for all 13 tables: indexes, CHECK constraints (amount_nano \u003e 0), FK cascading, monthly partitions for ledger_entries/deal_events/posting_checks, immutability triggers for append-only tables. Choose Flyway/Liquibase.","acceptance_criteria":"Migration tool chosen; V1__init.sql with all 13 tables; All indexes; CHECK constraints; Partition creation; Immutability triggers","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":150,"created_at":"2026-02-11T01:37:14.365016+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.596429+03:00","closed_at":"2026-02-11T02:32:29.596429+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["database","postgresql","schema"]}
{"id":"advert-market-aaj","title":"[H-12] MetricsFacade high-cardinality tags from lock keys","description":"RedisDistributedLock tags with entity IDs. Unbounded cardinality. Memory leak.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:53.387979+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.662356+03:00","closed_at":"2026-02-13T00:30:22.662356+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-ar3","title":"Acceptance Criteria","description":"- Error codes grouped by domain","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.508148+03:00","updated_at":"2026-02-11T01:36:34.93391+03:00","closed_at":"2026-02-11T01:36:34.93391+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-av4","title":"Phase 3: Financial System","description":"TON escrow, double-entry ledger, deposit watching, payout execution, commission. Core payment flow.","design":"Modules: financial-api, financial. Specs: 01, 08, 15, 25, 30, 31, 37, 38, 39, 40, 41, 42, 43","status":"open","priority":1,"issue_type":"epic","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T10:44:30.282935+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:44:30.282935+03:00","labels":["financial","phase-3"]}
{"id":"advert-market-av4.1","title":"Ledger Service (Double-Entry)","description":"Append-only double-entry ledger, account balances CQRS projection.\n\n## Specs\n- .memory-bank/07-financial-system/01-ledger-design.md\n- .memory-bank/07-financial-system/05-account-types.md\n- .memory-bank/07-financial-system/07-entry-type-catalog.md\n- .memory-bank/05-patterns-and-decisions/05-double-entry-ledger.md\n- .memory-bank/05-patterns-and-decisions/02-cqrs.md\n\n## Что реализовать\n\n### financial-api\n- LedgerPort interface: record(entries), getBalance(accountId), getEntries(accountId, cursor)\n- LedgerEntry record: id, dealId, accountId, entryType, debitNano, creditNano, txRef, description, idempotencyKey, createdAt\n- AccountBalance record: accountId, balanceNano, lastEntryId, version\n\n### financial-impl\n- LedgerService: core bookkeeping\n  1. Validate: SUM(debit) = SUM(credit) per tx_ref\n  2. Check idempotency_key (DB-backed, ledger_idempotency_keys table)\n  3. INSERT ledger_entries (append-only)\n  4. UPDATE account_balances (CQRS projection, optimistic lock)\n  5. Всё в одной транзакции\n\n- LedgerRepository (jOOQ): append entries, query by account\n- AccountBalanceRepository (jOOQ): upsert balance projection\n\n### Key Invariants\n- NEVER UPDATE/DELETE ledger_entries (trigger enforced)\n- SUM(debit_nano) = SUM(credit_nano) per tx_ref\n- idempotency_key UNIQUE per partition (monthly)\n- All amounts in nanoTON (BIGINT, no floats)\n\n### Account Types\nSingleton: PLATFORM_TREASURY, EXTERNAL_TON (contra, может быть отрицательным), NETWORK_FEES, DUST_WRITEOFF\nPer-deal: ESCROW:{deal_id}, COMMISSION:{deal_id}, OVERPAYMENT:{deal_id}, PARTIAL_DEPOSIT:{deal_id}, LATE_DEPOSIT:{deal_id}\nPer-user: OWNER_PENDING:{user_id}\n\n### Redis Balance Cache\n- Key: balance:{account_id}, TTL 5min\n- Invalidate on ledger write\n- Fallback to DB on cache miss\n\n## Подсказки\n- jOOQ batch insert для paired entries (debit + credit)\n- ledger_idempotency_keys: INSERT ON CONFLICT DO NOTHING, check affected rows\n- account_balances.balance_nano: NO \u003e= 0 constraint (EXTERNAL_TON goes negative)\n- version для optimistic locking","status":"open","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":480,"created_at":"2026-02-12T10:48:09.200717+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:48:09.200717+03:00","labels":["financial","ledger","phase-3"],"dependencies":[{"issue_id":"advert-market-av4.1","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T10:48:09.201537+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.1","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:16:28.557772+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.1","depends_on_id":"advert-market-z8x.4","type":"blocks","created_at":"2026-02-12T11:16:28.660404+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-av4.2","title":"TON SDK Integration + Wallet Service","description":"ton4j integration: address generation, TX building, signing, TON Center API.\n\n## Specs\n- .memory-bank/14-implementation-specs/01-ton-sdk-integration.md\n- .memory-bank/14-implementation-specs/08-ton-center-api-catalog.md\n- .memory-bank/14-implementation-specs/43-seqno-management.md\n\n## Что реализовать\n\n### financial-api\n- TonWalletPort interface: generateDepositAddress(dealId), submitPayout(dealId, address, amountNano), submitRefund(dealId, address, amountNano)\n- TonTransactionDto record: id, dealId, txHash, direction(IN/OUT), status, amountNano, confirmations\n\n### financial-impl\n- TonWalletService: ton4j WalletV4R2\n  - Address generation: subwallet_id из deal_subwallet_seq\n  - Non-bounceable (UQ...) для deposits\n  - TX building: internal transfer → sign → sendBoc\n  \n- TonBlockchainClient: HTTP client для TON Center API\n  - GET /getTransactions (deposit watching)\n  - POST /sendBoc (submit TX)\n  - GET /getMasterchainInfo (seqno tracking)\n  - GET /getAddressBalance\n  - POST /estimateFee\n\n- DepositWatcher (@Scheduled)\n  - Poll getTransactions для каждого active deposit address\n  - Calculate confirmations: current_masterchain_seqno - tx_block_seqno\n  - Emit DepositConfirmedEvent → escrow.confirmations\n\n- TonTransactionRepository (jOOQ): CRUD ton_transactions\n\n### Seqno Management\n- Per-subwallet seqno tracking (deals.last_known_seqno)\n- Seqno acquisition: getSeqno API → SET NX EX в Redis\n- Collision avoidance: Redis lock lock:seqno:{subwallet_id}\n\n### Configuration\n- TonProperties record: api.base-url, api.key, wallet.mnemonic (encrypted), deposit.poll-interval(10s), network(testnet/mainnet)\n\n## Подсказки\n- ton4j 1.3.2: Wallet → WalletV4R2.builder().subWalletId(N).build()\n- address.toNonBounceable() для deposit addresses\n- НИКОГДА не логировать mnemonic/private key\n- Circuit breaker на TON Center API (см. spec 28)","status":"open","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":480,"created_at":"2026-02-12T10:48:41.871005+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:48:41.871005+03:00","labels":["financial","phase-3","ton"],"dependencies":[{"issue_id":"advert-market-av4.2","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T10:48:41.871589+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.2","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:16:28.772513+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-av4.3","title":"Escrow Service + Confirmation Policy","description":"Escrow lifecycle: deposit address → hold → release/refund. Tiered confirmation policy.\n\n## Specs\n- .memory-bank/07-financial-system/02-escrow-flow.md\n- .memory-bank/14-implementation-specs/15-confirmation-policy.md\n- .memory-bank/14-implementation-specs/31-overpayment-underpayment.md\n- .memory-bank/14-implementation-specs/39-late-deposit-handling.md\n\n## Что реализовать\n\n### financial-api\n- EscrowPort interface: generateAddress(dealId), confirmDeposit(dealId, txHash, amountNano), release(dealId), refund(dealId)\n- EscrowStatus enum: AWAITING_DEPOSIT, PARTIALLY_FUNDED, FUNDED, RELEASED, REFUNDED\n\n### financial-impl\n- EscrowService: orchestrates escrow lifecycle\n  1. generateAddress: create subwallet, store deposit_address in deals\n  2. confirmDeposit: validate amount, record ledger entries (ESCROW_DEPOSIT)\n  3. release: record release entries (ESCROW_RELEASE + OWNER_PAYOUT + PLATFORM_COMMISSION)\n  4. refund: record refund entries (ESCROW_REFUND)\n\n- ConfirmationPolicyService: tiered confirmation requirements\n  - ≤100 TON: 1 confirmation\n  - ≤1000 TON: 3 confirmations\n  - \u003e1000 TON: 5 confirmations + operator review\n\n- OverpaymentHandler: excess → OVERPAYMENT:{deal_id} account, auto-refund or operator review\n- UnderpaymentHandler: partial → PARTIAL_DEPOSIT:{deal_id}, wait for remainder\n- LateDepositHandler: deposit to expired/cancelled deal → LATE_DEPOSIT:{deal_id}, auto-refund\n\n### Ledger Entry Flows\n**Deposit**: DEBIT EXTERNAL_TON, CREDIT ESCROW:{deal_id}\n**Release**: DEBIT ESCROW, CREDIT COMMISSION:{deal_id} (10%) + CREDIT OWNER_PENDING:{user_id} (90%)\n**Refund**: DEBIT ESCROW, CREDIT EXTERNAL_TON (minus gas), DEBIT PLATFORM_TREASURY, CREDIT NETWORK_FEES\n**Overpayment**: DEBIT EXTERNAL_TON, CREDIT OVERPAYMENT:{deal_id}\n\n### Configuration\n- ConfirmationPolicyProperties: tiers list (maxAmountTon, confirmations, operatorReview)\n\n## Подсказки\n- Зависит от: Ledger Service (double-entry записи), TON SDK (address generation)\n- Все ledger operations через LedgerService.record() — единая точка\n- Idempotency: idempotency:deposit:{tx_hash}\n- Distributed lock: lock:deposit:{deal_id}","status":"open","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":360,"created_at":"2026-02-12T11:11:43.444294+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:11:43.444294+03:00","labels":["escrow","financial","phase-3"],"dependencies":[{"issue_id":"advert-market-av4.3","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T11:11:43.445357+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.3","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:16:28.887973+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.3","depends_on_id":"advert-market-av4.2","type":"blocks","created_at":"2026-02-12T11:16:28.993489+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-av4.4","title":"Payout Execution + Commission Sweep","description":"Payout executor worker, commission sweep, network fee accounting.\n\n## Specs\n- .memory-bank/14-implementation-specs/30-payout-execution-flow.md\n- .memory-bank/14-implementation-specs/40-payout-wallet-architecture.md\n- .memory-bank/14-implementation-specs/25-commission-rounding-sweep.md\n- .memory-bank/14-implementation-specs/38-network-fee-accounting.md\n- .memory-bank/14-implementation-specs/41-unclaimed-payouts.md\n\n## Что реализовать\n\n### PayoutExecutorWorker (financial-impl)\nKafka consumer (escrow.commands, cg-payout-executor):\n1. Acquire lock: lock:payout:{deal_id} (60s)\n2. Check idempotency: idempotency:payout:{deal_id} (Redis SET NX EX 86400)\n3. Decrypt payout address from PII Vault\n4. Submit TX via TON sendBoc\n5. Record ton_transactions (direction=OUT, status=PENDING)\n6. Poll for confirmation (1 confirmation)\n7. Record withdrawal entries: DEBIT OWNER_PENDING, CREDIT EXTERNAL_TON\n8. Record fee: DEBIT PLATFORM_TREASURY, CREDIT NETWORK_FEES\n\n### RefundExecutorWorker (financial-impl)\nSame pattern for refunds: DEBIT ESCROW, CREDIT EXTERNAL_TON, fee accounting.\n\n### CommissionSweepService (financial-impl)\n@Scheduled daily 02:00 UTC:\n1. Find COMMISSION:{deal_id} accounts with balance \u003e dust threshold\n2. Build batch TX: subwallet → treasury_wallet\n3. Ledger: DEBIT COMMISSION:{deal_id}, CREDIT PLATFORM_TREASURY\n4. Fee: DEBIT PLATFORM_TREASURY, CREDIT NETWORK_FEES\n5. Idempotency: sweep:{date}:{account_id}\n\n### Commission Calculation\n- commission_tiers table: tiered rates (basis points)\n- commissionNano = dealAmountNano * rateBp / 10_000L (floor)\n- ownerPayoutNano = dealAmountNano - commissionNano (exact)\n- Invariant: commission + owner_payout == deal_amount\n\n### Unclaimed Payouts\n- Owner без TON address: OWNER_PENDING accumulates\n- Notification: 3 reminders (1d, 7d, 21d)\n- 30-day timeout: operator review\n\n### Configuration\n- PayoutProperties: max-retries(5), retry-backoff\n- CommissionProperties: default-rate-bp(1000), sweep.cron\n- NetworkFeeProperties: default-estimate-nano\n\n## Подсказки\n- Зависит от: Ledger, TON SDK, Escrow, PII Vault\n- Single-phase ledger recording (AFTER on-chain confirmation)\n- Dust \u003c 1000 nanoTON: monthly write-off\n- NEVER drop payout command — DLQ + alert if all retries exhausted","status":"open","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":360,"created_at":"2026-02-12T11:11:48.235777+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:11:48.235777+03:00","labels":["financial","payout","phase-3"],"dependencies":[{"issue_id":"advert-market-av4.4","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T11:11:48.236947+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.4","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:16:29.099695+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.4","depends_on_id":"advert-market-av4.2","type":"blocks","created_at":"2026-02-12T11:16:29.215535+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.4","depends_on_id":"advert-market-av4.3","type":"blocks","created_at":"2026-02-12T11:16:29.335307+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-av4.5","title":"Deal Workflow Engine (Side-Effects)","description":"Post-transition side-effects orchestrator: notifications, deadlines, escrow commands.\n\n## Specs\n- .memory-bank/14-implementation-specs/35-deal-workflow-engine.md\n\n## Что реализовать\n\n### DealWorkflowEngine (deal-impl)\nВызывается ПОСЛЕ DealTransitionService.transition() в той же транзакции.\nМаппинг targetStatus → side-effects:\n\n- OFFER_PENDING: notify owner (NEW_OFFER), set 48h deadline\n- ACCEPTED: generate deposit address (EscrowPort), notify advertiser (OFFER_ACCEPTED)\n- FUNDED: record ESCROW_DEPOSIT entries, set 72h deadline, notify owner (ESCROW_FUNDED)\n- CREATIVE_SUBMITTED: notify advertiser (CREATIVE_SUBMITTED), set 48h deadline\n- CREATIVE_APPROVED: notify owner (CREATIVE_APPROVED), set 48h deadline\n- SCHEDULED: emit PUBLISH_POST → delivery.commands\n- PUBLISHED: emit VERIFY_DELIVERY → delivery.commands, set 24h deadline, notify advertiser\n- COMPLETED_RELEASED: release escrow (3 entries), emit EXECUTE_PAYOUT → escrow.commands, notify both (DELIVERY_VERIFIED + PAYOUT_SENT)\n- DISPUTED: notify both (DISPUTE_OPENED), set 7-day deadline\n- REFUNDED: record refund entries, emit EXECUTE_REFUND → escrow.commands, notify both\n- CANCELLED/EXPIRED: notify relevant party (DEAL_CANCELLED/DEAL_EXPIRED)\n\n### Side-Effect Implementation\n- Notifications: INSERT INTO notification_outbox (transactional outbox)\n- Deadlines: UPDATE deals SET deadline_at = now() + interval\n- Kafka commands: INSERT INTO outbox (для escrow/delivery commands)\n- Escrow operations: EscrowPort (synchronous in-process call)\n\n### Dependencies (via -api ports)\n- financial-api: EscrowPort\n- identity-api: user resolution\n- marketplace-api: channel info\n- communication-api: NotificationPort\n\n## Подсказки\n- Все side-effects в одной DB транзакции с state transition\n- Strategy pattern: Map\u003cDealStatus, WorkflowHandler\u003e\n- Зависит от: Deal State Machine, Ledger, Escrow, Outbox","notes":"ДОПОЛНИТЕЛЬНЫЕ ENDPOINTS (найдены при аудите):\n- POST /api/v1/deals/{id}/publish — trigger manual publication (owner action)\n- POST /api/v1/deals/{id}/schedule — confirm scheduling (sets scheduled_at, transitions CREATIVE_APPROVED → SCHEDULED)\nОба endpoint — state transitions с side-effects через WorkflowEngine.","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T11:11:56.300351+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:38:09.662883+03:00","labels":["deal","phase-3","workflow"],"dependencies":[{"issue_id":"advert-market-av4.5","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T11:11:56.30171+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.5","depends_on_id":"advert-market-6wx.2","type":"blocks","created_at":"2026-02-12T11:16:29.452939+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.5","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:16:29.565997+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.5","depends_on_id":"advert-market-av4.3","type":"blocks","created_at":"2026-02-12T11:16:29.676299+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-av4.6","title":"Wallet REST API (balance, transactions, withdraw)","description":"REST endpoints для финансового раздела: баланс, история, вывод средств.\n\n## Specs\n- .memory-bank/11-api-contracts.md (wallet endpoints)\n- .memory-bank/15-frontend-pages/04-wallet.md\n\n## Предпосылки\nLedger Service (av4.1) реализует core bookkeeping, но нет REST endpoints\nдля пользователей. Frontend (bol) зависит от этих endpoints.\n\n## Что реализовать\n\n### financial-api (дополнение)\n- WalletPort interface:\n  - getSummary(userId) → WalletSummary\n  - getTransactions(userId, cursor, limit) → CursorPage\u003cTransactionDto\u003e\n  - getTransaction(userId, txId) → TransactionDto\n  - requestWithdraw(userId, address, amountNano) → WithdrawResult\n- WalletSummary record:\n  - Owner: pendingBalanceNano, availableBalanceNano, totalEarnedNano\n  - Advertiser: totalInEscrowNano, totalSpentNano\n- TransactionDto record: id, dealId, type(EntryType), amountNano, balanceAfterNano, description, createdAt\n- WithdrawResult record: txId, status, estimatedCompletionAt\n\n### financial-impl\n- WalletService:\n  - getSummary: aggregate from account_balances (OWNER_PENDING:{userId}, PLATFORM_TREASURY)\n  - getTransactions: query ledger_entries by user-related accounts, cursor pagination\n  - requestWithdraw:\n    1. Validate: user has TON address in PII vault\n    2. Validate: available balance \u003e= amount + estimated fee\n    3. Create withdrawal request (outbox → escrow.commands)\n    4. Return pending status\n\n### REST API\n- GET  /api/v1/wallet/summary — financial overview\n- GET  /api/v1/wallet/transactions — transaction history (cursor pagination)\n- GET  /api/v1/wallet/transactions/{txId} — transaction detail\n- POST /api/v1/wallet/withdraw — request withdrawal\n  - Body: { amountNano, address (optional, use saved) }\n\n### ABAC\n- All wallet endpoints: authenticated user only, own data\n- @PreAuthorize(\"isAuthenticated()\")\n\n## Подсказки\n- Зависит от: Ledger (av4.1), Auth (z8x.5), PII Vault (4fr.3 — для address)\n- Cursor pagination через CursorPage (shared kernel)\n- Owner видит OWNER_PENDING balance; Advertiser видит ESCROW balances","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:36:39.063527+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:36:39.063527+03:00","labels":["api","financial","phase-3","wallet"],"dependencies":[{"issue_id":"advert-market-av4.6","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T11:36:39.064182+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.6","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:37:42.854136+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.6","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:37:43.091889+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-av4.7","title":"Hot Wallet Management + Balance Monitoring","description":"Treasury wallet мониторинг, алерты баланса, пополнение.\n\n## Specs\n- .memory-bank/14-implementation-specs/37-hot-wallet-management.md\n\n## Что реализовать\n\n### financial-impl\n- HotWalletMonitor (@Scheduled every 5min):\n  1. getAddressBalance(treasury_address) via TON Center\n  2. Compare with threshold: if balance \u003c min_threshold → ALERT\n  3. Metrics: ton.treasury.balance (Gauge)\n\n- Admin API:\n  - GET /api/v1/admin/treasury/status — current balance, pending payouts, pending sweeps\n  - POST /api/v1/admin/treasury/alert-config — update thresholds\n\n### Alert Thresholds\n- WARNING: balance \u003c 100 TON\n- CRITICAL: balance \u003c 10 TON (payouts will fail)\n- Notification: operator via Telegram bot\n\n### Cold-to-Hot Transfer (manual for MVP)\n- Operator deposits from cold wallet → treasury address\n- Deposit detected by existing Deposit Watcher (special case: treasury self-deposit)\n- Ledger: no entry needed (internal transfer)\n\n### Metrics\n- ton.treasury.balance (Gauge)\n- ton.treasury.pending.payouts.count (Gauge)\n- ton.treasury.pending.sweeps.count (Gauge)\n\n## Подсказки\n- Зависит от: TON SDK (av4.2), Payout (av4.4)\n- MVP: manual replenishment, auto-alerting only\n- Treasury address = WalletV4R2 с subwallet_id=0","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T11:37:05.180425+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:37:05.180425+03:00","labels":["financial","operations","phase-3","wallet"],"dependencies":[{"issue_id":"advert-market-av4.7","depends_on_id":"advert-market-av4","type":"parent-child","created_at":"2026-02-12T11:37:05.181341+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.7","depends_on_id":"advert-market-av4.2","type":"blocks","created_at":"2026-02-12T11:37:44.007465+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-av4.7","depends_on_id":"advert-market-av4.4","type":"blocks","created_at":"2026-02-12T11:37:44.218025+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-b2k","title":"Auth Flow — initData HMAC + Session Management","description":"Finalize auth: Telegram initData HMAC-SHA256 validation, session choice (JWT vs opaque), token structure (claims, expiry), refresh mechanism, anti-replay window, Spring Security integration.","acceptance_criteria":"initData HMAC validation code example; JWT/session decision; Token claims structure; Session storage (Redis key schema); Spring Security filter chain config","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":90,"created_at":"2026-02-11T01:37:14.121129+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.594176+03:00","closed_at":"2026-02-11T02:32:29.594176+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["auth","security","telegram"]}
{"id":"advert-market-b6m","title":"[H-10] TelegramNotificationService sends unescaped template text","description":"Template text from i18n not pre-escaped. Telegram parse errors on special chars.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:53.118684+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.665161+03:00","closed_at":"2026-02-13T00:30:22.665161+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-bka","title":"Creative Brief \u0026 Draft JSONB Schemas","description":"JSON schemas for deals.creative_brief and deals.creative_draft: required/optional fields, content type restrictions, media format, size limits, draft version tracking.","acceptance_criteria":"JSON Schema for brief; JSON Schema for draft; Validation rules; Version tracking; Schema evolution path","status":"closed","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":30,"created_at":"2026-02-11T01:38:42.146183+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.369865+03:00","closed_at":"2026-02-11T02:32:56.369865+03:00","close_reason":"Implementation spec files created","labels":["creative","deals","schema"]}
{"id":"advert-market-boc","title":"Commission Rounding \u0026 Sweep Mechanism","description":"Integer arithmetic rounding direction (floor commission, ceil owner payout), sweep schedule (daily), COMMISSION:{deal_id} -\u003e PLATFORM_TREASURY sweep SQL, segment config table design.","acceptance_criteria":"Rounding rules with examples; Sweep schedule/trigger; Sweep ledger entry pattern; Segment config table; Edge case: indivisible amounts","status":"closed","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":30,"created_at":"2026-02-11T01:39:19.003964+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.375365+03:00","closed_at":"2026-02-11T02:32:56.375365+03:00","close_reason":"Implementation spec files created","labels":["commission","financial"]}
{"id":"advert-market-bol","title":"Frontend: Wallet + Profile Pages","description":"Финансовый раздел и профиль пользователя.\n\n## Specs\n- .memory-bank/15-frontend-pages/04-wallet.md\n- .memory-bank/15-frontend-pages/05-profile.md\n\n## Что реализовать\n\n### Wallet Pages\n- /wallet — balance summary (owner: pending, available; advertiser: escrow total)\n- /wallet/withdraw — withdraw form (owner: TON address + amount)\n- /wallet/history — transaction history (infinite scroll)\n- /wallet/history/:id — transaction detail\n\n### Profile Pages\n- /profile — settings (language, notifications, TON address)\n- /profile/channels — my channels list\n- /profile/channels/register — register new channel\n- /profile/channels/:id — channel management (edit, pricing, team)\n- /profile/channels/:id/team — team members (invite, remove, permissions)\n\n### Key Components\n- BalanceCard: TON amount display\n- TransactionRow: debit/credit with icon\n- QRCodeDisplay: deposit address QR\n- TeamMemberRow: role badge + permissions\n\n## Подсказки\n- TON Connect (optional для MVP): wallet connection\n- QR code: qrcode.react library\n- Зависит от: Frontend Shell, Ledger API, Channel Service API","status":"open","priority":3,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T11:15:06.241377+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:15:06.241377+03:00","labels":["frontend","profile","wallet"],"dependencies":[{"issue_id":"advert-market-bol","depends_on_id":"advert-market-04t","type":"blocks","created_at":"2026-02-12T11:16:56.892585+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-bol","depends_on_id":"advert-market-av4.1","type":"blocks","created_at":"2026-02-12T11:16:57.109928+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-bol","depends_on_id":"advert-market-6wx.1","type":"blocks","created_at":"2026-02-12T11:16:57.347183+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-c4i","title":"Kafka Consumer Error Handling Strategy","description":"Dead letter topic naming/schema, poison message isolation, retry with exponential backoff, consumer lag alerting thresholds, offset commit strategy, rebalancing.","acceptance_criteria":"DLT naming and schema; Poison message handling; Retry policy per consumer group; Lag alert thresholds; Offset commit strategy","status":"closed","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":45,"created_at":"2026-02-11T01:38:41.909289+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.367485+03:00","closed_at":"2026-02-11T02:32:56.367485+03:00","close_reason":"Implementation spec files created","labels":["error-handling","kafka","workers"]}
{"id":"advert-market-c74","title":"[C-4] JWT secret has no minimum length validation","description":"Only @NotBlank on JWT secret. HMAC-SHA256 requires min 32 bytes. Add @Size(min=32).","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:30.43057+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.656073+03:00","closed_at":"2026-02-13T00:30:22.656073+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-cds","title":"[H-8] Actuator metrics/prometheus publicly accessible","description":"Business metrics, infra topology exposed. Move to management port.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:48.18643+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.667649+03:00","closed_at":"2026-02-13T00:30:22.667649+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-cnu","title":"Acceptance Criteria","description":"- Schema for each of 8 topics with all fields, types, required/optional","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.50563+03:00","updated_at":"2026-02-11T01:36:35.51027+03:00","closed_at":"2026-02-11T01:36:35.51027+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-csx","title":"Acceptance Criteria","description":"- Templates for all 15 notification types","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.510502+03:00","updated_at":"2026-02-11T01:36:34.199283+03:00","closed_at":"2026-02-11T01:36:34.199283+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-ddn","title":"Acceptance Criteria","description":"- JSON schema for each of 6 event types","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.507517+03:00","updated_at":"2026-02-11T01:36:35.082787+03:00","closed_at":"2026-02-11T01:36:35.082787+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-dg8","title":"Rate Limiting + External API Resilience","description":"Multi-layer rate limiting (Redis token bucket) + Circuit breakers (Resilience4j).\n\n## Specs\n- .memory-bank/14-implementation-specs/27-rate-limiting-strategy.md\n- .memory-bank/14-implementation-specs/28-external-api-resilience.md\n\n## Что реализовать\n\n### Rate Limiting (shared + app)\n- RateLimitFilter (Spring filter): Redis token bucket per user/endpoint\n- Lua script: token bucket алгоритм\n- Tiers: Auth 5/min, Deals write 20/min, Deals read 60/min, Global 120/min\n- Business limits: 10 active deals/advertiser, 5 deals/channel/day, 3 disputes/user/week\n- Outbound: Guava RateLimiter — TON API 10 req/s, Telegram 30 msg/s\n- Response headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset\n- Auth brute-force: progressive delays + lockout after 11 failures\n\n### Circuit Breakers (app)\n- TON Center: window 20, threshold 50%, open 30s, half-open 5 calls\n- Telegram Bot: window 50, threshold 40%, open 15s, half-open 10 calls\n- Telegram Platform: time-based 60s, threshold 30%, open 10s\n- Bulkhead: TON 10 concurrent, Telegram 30 concurrent\n- Timeouts: TON 35s, Telegram 15s, Platform 8s\n\n### Fallbacks\n- TON down: skip poll, queue payouts, alert operator\n- Telegram down: queue in outbox, retry later\n\n### Metrics\n- ratelimit.requests.total/limited{tier,endpoint}\n- resilience4j.circuitbreaker.state/calls{name}\n\n## Подсказки\n- Resilience4j + Spring Boot starter\n- Redis Lua script для atomic token bucket\n- 429 → Retry-After header","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T11:14:28.029473+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:14:28.029473+03:00","labels":["cross-cutting","resilience"],"dependencies":[{"issue_id":"advert-market-dg8","depends_on_id":"advert-market-av4.2","type":"blocks","created_at":"2026-02-12T11:16:55.798107+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-dlp","title":"Acceptance Criteria","description":"- build.gradle.kts compiles with all dependencies","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.506138+03:00","updated_at":"2026-02-11T01:36:35.376834+03:00","closed_at":"2026-02-11T01:36:35.376834+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-dss","title":"Metrics, SLOs \u0026 Monitoring","description":"Comprehensive Micrometer metrics, SLO definitions, Prometheus + Grafana.\n\n## Specs\n- .memory-bank/14-implementation-specs/21-metrics-slos-monitoring.md\n- .memory-bank/14-implementation-specs/32-worker-monitoring-dlq.md\n\n## Что реализовать\n\n### Metrics (all modules, via MetricsFacade в shared)\n**API**: http.server.requests, api.auth.login, api.deals.transition\n**Financial**: escrow.deposit/payout/refund, ledger.entries.created, reconciliation.check\n**Workers**: worker.deposit.poll, worker.delivery.check, worker.notification.sent\n**Infra**: kafka.consumer.lag, outbox.lag, redis.lock.acquired, ton.api.requests\n\n### SLOs\n- API: p50\u003c100ms, p95\u003c500ms, p99\u003c2s, error\u003c0.1%\n- Deal: completion\u003e80%, avg\u003c72h, dispute\u003c5%\n- Financial: deposit detection\u003c2min, payout\u003c10min, reconciliation 100%\n- Notifications: delivery\u003e99%, latency\u003c5s\n\n### Worker Monitoring\n- Heartbeat: Redis key worker:{name}:heartbeat (TTL 60s)\n- DLQ monitoring: consumer on each .DLT topic, alert on any message\n- Health checks: custom HealthIndicator per worker\n\n### Grafana Dashboards (JSON provisioning)\n1. API Overview (request rate, error rate, latency)\n2. Financial Operations (deposits, payouts, balance)\n3. Infrastructure (Kafka lag, outbox, Redis, TON API)\n\n### Alerting Rules\n- Immediate: API down, reconciliation failure, DLQ financial messages, worker heartbeat missing\n- 5min: error rate\u003e5%, payout stuck\u003e10min\n\n## Подсказки\n- MetricsFacade в shared уже существует (расширить)\n- Micrometer auto-configured (actuator/prometheus endpoint)\n- Зависит от реализации основных features (metrics добавляются инкрементально)","status":"open","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:14:37.233982+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:14:37.233982+03:00","labels":["cross-cutting","monitoring"]}
{"id":"advert-market-efk","title":"[C-7] Infrastructure concrete classes in shared module","description":"RedisDistributedLock, OutboxPoller are @Component in shared. Move to app or infrastructure module.","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:33.943976+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.681704+03:00","closed_at":"2026-02-13T00:30:22.681704+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-fxc","title":"[H-11] Login rate limiting uses getRemoteAddr() (proxy bypass)","description":"Behind reverse proxy = shared IP. One attacker blocks all logins.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:53.250591+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.663802+03:00","closed_at":"2026-02-13T00:30:22.663802+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-ggx","title":"Deployment Infrastructure (Docker, nginx, CORS, CSP)","description":"Production deployment pipeline: Docker images, nginx, security headers, CI/CD.\n\n## Specs\n- .memory-bank/14-implementation-specs/23-deployment-runbook.md\n- .memory-bank/09-deployment.md\n- .memory-bank/10-security-and-compliance.md (CORS, CSP)\n\n## Что реализовать\n\n### Docker (backend)\n- Dockerfile: multi-stage (gradle build → JRE slim runtime)\n- docker-compose.prod.yml: app + db + redis + kafka (single VPS)\n- Health checks: /actuator/health\n\n### Docker (frontend)\n- Dockerfile: multi-stage (node build → nginx serve)\n- nginx.conf:\n  - SPA fallback: try_files $uri /index.html\n  - Static assets: cache-control 1y\n  - Gzip compression\n  - Security headers\n\n### Security Headers (nginx)\n- Content-Security-Policy: default-src 'self'; script-src 'self' https://telegram.org\n- X-Frame-Options: ALLOW-FROM https://web.telegram.org\n- X-Content-Type-Options: nosniff\n- Referrer-Policy: strict-origin-when-cross-origin\n\n### CORS (Spring Security)\n- CorsConfiguration в SecurityFilterChain\n- Allowed origins: Telegram Web App domains\n- Allowed methods: GET, POST, PUT, DELETE\n- Allowed headers: Authorization, Content-Type\n\n### CI/CD (GitHub Actions)\n- Build backend → build frontend → Docker push → deploy to server\n- SSH deploy script: docker compose pull \u0026\u0026 docker compose up -d\n\n### TLS\n- Let's Encrypt via certbot + nginx\n- Auto-renewal cron\n\n## Подсказки\n- Server: 94.228.112.90, user: ad-marketplace\n- Docker already installed (29.2.1)\n- Зависит от: минимум Auth (z8x.5) + один endpoint для smoke test","status":"open","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:37:28.304949+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:37:28.304949+03:00","labels":["cross-cutting","deployment","infrastructure"],"dependencies":[{"issue_id":"advert-market-ggx","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:37:44.889473+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-h04","title":"[Docs] Migrate memory-bank to English-only with escaped RU examples","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-13T12:03:47.334945+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T12:15:03.172666+03:00","closed_at":"2026-02-13T12:15:03.172666+03:00","close_reason":"Closed"}
{"id":"advert-market-hew","title":"[C-3] Login rate limiter fails open on Redis error","description":"DataAccessException caught and logged. Request proceeds. Must fail-closed (429/503) or add in-memory fallback.","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:29.306744+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.657396+03:00","closed_at":"2026-02-13T00:30:22.657396+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-ivb","title":"Dispute Auto-Resolution Rules Engine","description":"Concrete auto-resolution rules: conditions (post deleted -\u003e refund, edited -\u003e refund, creative timeout -\u003e refund), priority/conflict resolution, operator escalation triggers, configuration approach (code vs DB).","acceptance_criteria":"Rule catalog with conditions/outcomes; Priority order; Escalation criteria; Config approach; Evidence requirements","status":"closed","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:38:41.67575+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.36481+03:00","closed_at":"2026-02-11T02:32:56.36481+03:00","close_reason":"Implementation spec files created","labels":["business-logic","dispute"]}
{"id":"advert-market-iyh","title":"Acceptance Criteria","description":"- Metric catalog (name, type, tags)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.510278+03:00","updated_at":"2026-02-11T01:36:34.268577+03:00","closed_at":"2026-02-11T01:36:34.268577+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-izh","title":"[H-3] UpdateDeduplicator has no Redis error handling","description":"No DataAccessException catch. Combined with 200-on-error, updates lost or duplicated.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:47.589328+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.673894+03:00","closed_at":"2026-02-13T00:30:22.673894+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-m0x","title":"TON Center API Client (endpoint catalog)","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:04.393785+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T12:13:20.487203+03:00","closed_at":"2026-02-12T12:13:20.487203+03:00","close_reason":"Superseded by av4.2 (TON SDK Integration + Wallet Service) which covers spec 08","labels":["api","phase-3","ton"],"dependencies":[{"issue_id":"advert-market-m0x","depends_on_id":"advert-market-av4","type":"blocks","created_at":"2026-02-12T11:50:53.768+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-mtt","title":"[C-1] TelegramRateLimiter fails open — sends always proceed","description":"acquire() returns normally on timeout. Retries bypass rate limiting. Must fail-closed or block.","status":"closed","priority":0,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:26.798696+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.659912+03:00","closed_at":"2026-02-13T00:30:22.659912+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-n44","title":"PII Encryption \u0026 Key Management Spec","description":"Key management (env var MVP, KMS Scaled), AES-256-GCM nonce/IV handling, encryption library choice, key rotation with key_version, PII Vault code patterns.","acceptance_criteria":"Key storage per environment; Encryption/decryption code example; Nonce/IV strategy; Key rotation procedure; pii_store.key_version usage","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:37:14.588095+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.598853+03:00","closed_at":"2026-02-11T02:32:29.598853+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["encryption","pii","security"]}
{"id":"advert-market-n96","title":"[Docs] Migrate memory-bank legacy bilingual content to English","description":"Current policy allows legacy bilingual content. Track phased migration of .memory-bank files to fully English content while preserving links and anchors.","status":"open","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-13T11:42:54.722848+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T11:42:54.722848+03:00"}
{"id":"advert-market-npj","title":"[H-14] MetricsFacade and LocalizationService @Component in shared","description":"Infrastructure auto-registered from shared module. Remove @Component, register as @Bean in app.","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:53.658887+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.661088+03:00","closed_at":"2026-02-13T00:30:22.661088+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-onp","title":"Metrics, SLOs \u0026 Monitoring Definitions","description":"Micrometer metric names/tags, SLI/SLO definitions (API latency, deal completion rate), Prometheus alert rules, Grafana dashboard specs, structured logging format with correlation IDs.","acceptance_criteria":"Metric catalog; SLO targets; Alert rules with severity; Dashboard layouts; Log format spec","status":"closed","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:39:18.544509+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.370944+03:00","closed_at":"2026-02-11T02:32:56.370944+03:00","close_reason":"Implementation spec files created","labels":["devops","monitoring","observability"]}
{"id":"advert-market-q34","title":"[H-6] Deep link parameter injection in StartCommand","description":"Unvalidated user input concatenated into URLs. Path traversal/phishing possible.","status":"closed","priority":1,"issue_type":"bug","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:47.935756+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.670185+03:00","closed_at":"2026-02-13T00:30:22.670185+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-r36","title":"Zero-downtime deployment: health probes, graceful shutdown, idempotent webhook","status":"closed","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-11T13:40:38.250071+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T14:19:34.392676+03:00","closed_at":"2026-02-11T14:19:34.392676+03:00","close_reason":"Implemented: health probes, graceful shutdown, webhook idempotency, canary routing, blue-green deploy"}
{"id":"advert-market-rfl","title":"Acceptance Criteria","description":"- Polling SQL query with SKIP LOCKED","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.50789+03:00","updated_at":"2026-02-11T01:36:35.007203+03:00","closed_at":"2026-02-11T01:36:35.007203+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-sq9","title":"Telegram Bot Framework \u0026 Webhook Setup","description":"Choose Telegram Bot framework for Kotlin/Spring Boot, document webhook setup (TLS, path, port), define notification message templates (HTML/Markdown), bot token management, error handling for failed sends.","acceptance_criteria":"Bot framework chosen; Webhook registration procedure; Message templates for 15 notification types; Retry/fallback strategy; Bot token env config","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":90,"created_at":"2026-02-11T01:37:13.993913+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.592949+03:00","closed_at":"2026-02-11T02:32:29.592949+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["bot","integration","telegram"]}
{"id":"advert-market-tj7","title":"Phase 4: Delivery \u0026 Verification","description":"Post scheduling, 24h delivery verification, deal timeouts, channel stats. Content lifecycle.","design":"Modules: delivery-api, delivery, deal, marketplace. Specs: 17, 19, 44, 45","status":"open","priority":1,"issue_type":"epic","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T10:44:39.673857+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:44:39.673857+03:00","labels":["delivery","phase-4"]}
{"id":"advert-market-tj7.1","title":"Post Scheduler Worker","description":"Kafka worker: публикация одобренного контента в Telegram каналы.\n\n## Specs\n- .memory-bank/14-implementation-specs/44-post-scheduler-impl.md\n\n## Что реализовать\n\n### delivery-api\n- PostPublishPort interface: publish(command) → PublishResult\n- PublishPostCommand record: dealId, channelId, creativeDraft, scheduledAt\n- PublishResult record: messageId, publishedAt\n\n### delivery-impl\n- PostSchedulerWorker (Kafka consumer: delivery.commands, PUBLISH_POST)\n  1. Parse PublishPostCommand\n  2. Select Telegram method: sendMessage, sendPhoto, sendVideo, sendMediaGroup, etc.\n  3. Build InlineKeyboardMarkup from creative_draft.buttons[]\n  4. Execute via TelegramBotApiClient\n  5. Store published_message_id in deals\n  6. Transition SCHEDULED → PUBLISHED\n\n- CreativeMapper: JSONB CreativeDraft → Telegram API request\n  - text-only → sendMessage\n  - 1 photo → sendPhoto\n  - 1 video → sendVideo\n  - 2-10 media → sendMediaGroup + sendMessage (buttons separate)\n\n- Rate Limiter: Redis sorted sets, token bucket\n  - 1 req/3s per channel\n  - 30 req/s global\n\n### Error Handling\n- Retry: max 3, exponential 1s→2s→4s\n- Non-retryable (403 forbidden, expired file_id) → DLQ\n- Rate limited (429) → respect retry_after\n\n### Metrics\n- delivery.post_scheduler.published.total{media_type}\n- delivery.post_scheduler.errors.total{error_type}\n- delivery.post_scheduler.send.duration{media_type}\n\n## Подсказки\n- pengrad API: bot.execute(new SendMessage(chatId, text).parseMode(ParseMode.HTML))\n- Зависит от: Kafka schemas, Creative JSONB, Deal State Machine\n- InlineKeyboardMarkup для кнопок с URL","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T11:12:23.794178+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:12:23.794178+03:00","labels":["delivery","phase-4","scheduler"],"dependencies":[{"issue_id":"advert-market-tj7.1","depends_on_id":"advert-market-tj7","type":"parent-child","created_at":"2026-02-12T11:12:23.795544+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.1","depends_on_id":"advert-market-z8x.3","type":"blocks","created_at":"2026-02-12T11:16:39.539592+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.1","depends_on_id":"advert-market-6wx.3","type":"blocks","created_at":"2026-02-12T11:16:39.649939+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-tj7.2","title":"Delivery Verifier","description":"24h retention verification: 5 checkpoints, content hash comparison.\n\n## Specs\n- .memory-bank/14-implementation-specs/17-delivery-verifier-telegram-api.md\n- .memory-bank/03-feature-specs/05-delivery-verification.md\n\n## Что реализовать\n\n### delivery-impl\n- DeliveryVerifierWorker (Kafka consumer: delivery.commands, VERIFY_DELIVERY)\n  1. Parse VerifyDeliveryCommand: channelId, messageId, contentHash, publishedAt, checkNumber\n  2. Call Telegram API: getChat (verify access), forwardMessage/getMessages (read content)\n  3. Compute content hash: SHA-256(normalized_text + sorted_file_ids + sorted_button_labels)\n  4. Compare with original contentHash\n  5. Emit result → delivery.results\n\n- ContentHasher: SHA-256 hashing of post content\n  - Normalize: lowercase, trim whitespace, sort arrays\n  - Include: text + media file_ids + button labels\n\n- VerificationScheduler: schedules 5 checks per deal\n  - +1h, +4h, +8h, +16h, +24h after publish\n  - Each check = VERIFY_DELIVERY command with check_number\n\n### Failure Detection\n- Post deleted → POST_DELETED → trigger DISPUTED\n- Content edited → CONTENT_EDITED → trigger DISPUTED\n- Channel made private → CHANNEL_RESTRICTED → trigger DISPUTED\n- All 5 checks passed → DELIVERY_VERIFIED → trigger COMPLETED_RELEASED\n\n### Critical Rule\n- 24h timeout с unresolved checks → DISPUTED (NOT auto-approve!)\n- Это money-loss vector если auto-approve\n\n### Kafka Topics\n- Input: delivery.commands (VERIFY_DELIVERY)\n- Output: delivery.results (DELIVERY_VERIFIED / DELIVERY_FAILED)\n\n### Metrics\n- delivery.verifier.checks{result=PASS|FAIL|ERROR}\n- delivery.verifier.disputes{reason}\n\n## Подсказки\n- forwardMessage to self → read content → deleteMessage (cleanup)\n- pengrad: bot.execute(new ForwardMessage(selfChatId, channelId, messageId))\n- Зависит от: Post Scheduler (needs published_message_id)","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T11:12:37.00991+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:12:37.00991+03:00","labels":["delivery","phase-4","verifier"],"dependencies":[{"issue_id":"advert-market-tj7.2","depends_on_id":"advert-market-tj7","type":"parent-child","created_at":"2026-02-12T11:12:37.011149+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.2","depends_on_id":"advert-market-tj7.1","type":"blocks","created_at":"2026-02-12T11:16:39.771037+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-tj7.3","title":"Deal Timeout Scheduler","description":"DB-polling scheduler для автоматического expire/cancel/refund по дедлайнам.\n\n## Specs\n- .memory-bank/14-implementation-specs/19-deal-timeout-scheduler.md\n\n## Что реализовать\n\n### deal-impl\n- DealTimeoutScheduler (@Scheduled fixedDelay=30s)\n  1. Poll: SELECT FROM deals WHERE deadline_at \u003c= now()-5min AND status NOT IN (terminal) LIMIT 100 FOR UPDATE SKIP LOCKED\n  2. For each deal:\n     a. Acquire Redis lock: lock:deal:{deal_id}\n     b. Re-read deal state (prevent stale)\n     c. Execute state transition via DealTransitionService\n     d. If funded: emit EXECUTE_REFUND → escrow.commands\n     e. Emit DEAL_STATE_CHANGED → deal.events\n     f. Clear deadline_at\n\n### Timeout Table\n- OFFER_PENDING: 48h → EXPIRED\n- NEGOTIATING: 72h → EXPIRED\n- AWAITING_PAYMENT: 24h → EXPIRED\n- FUNDED: 72h → EXPIRED + REFUND\n- CREATIVE_SUBMITTED: 48h → EXPIRED + REFUND\n- CREATIVE_APPROVED: 48h → EXPIRED + REFUND\n- SCHEDULED: 24h → EXPIRED + REFUND\n- DELIVERY_VERIFYING: 24h → COMPLETED_RELEASED (if verified) / DISPUTED (if error)\n- DISPUTED: 7d → Escalate to operator\n\n### Configuration\n- DealTimeoutProperties: poll-interval(30s), batch-size(100), grace-period(5min)\n- Per-status timeout durations (configurable)\n\n### Metrics\n- deal.timeout.processed{status, outcome}\n- deal.timeout.poll.duration\n\n## Подсказки\n- FOR UPDATE SKIP LOCKED — не блокировать другие scheduler instances\n- Grace period (5min) — дать время на natural transitions\n- Зависит от: Deal State Machine, Redis Locks, Escrow (для refunds)","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:12:51.39814+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:12:51.39814+03:00","labels":["deal","phase-4","timeout"],"dependencies":[{"issue_id":"advert-market-tj7.3","depends_on_id":"advert-market-tj7","type":"parent-child","created_at":"2026-02-12T11:12:51.399479+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.3","depends_on_id":"advert-market-6wx.2","type":"blocks","created_at":"2026-02-12T11:16:39.879588+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.3","depends_on_id":"advert-market-z8x.4","type":"blocks","created_at":"2026-02-12T11:16:39.982577+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-tj7.4","title":"Channel Statistics Collector","description":"Background task для обновления subscriber_count, avg_views, engagement_rate.\n\n## Specs\n- .memory-bank/14-implementation-specs/45-channel-statistics-collector.md\n- .memory-bank/03-feature-specs/09-channel-statistics.md\n\n## Что реализовать\n\n### marketplace-impl\n- ChannelStatisticsCollector (@Scheduled fixedDelay=6h)\n  1. SELECT channels WHERE stats_updated_at IS NULL OR stats_updated_at \u003c now()-24h ORDER BY stats_updated_at NULLS FIRST LIMIT 100\n  2. For each: getChatMemberCount → subscriber_count\n  3. Update stats_updated_at\n\n- TelegramChannelStatsService: facade для Telegram API\n  - getChatMemberCount: subscriber count\n  - avg_views: owner-reported (MVP), TGStat API (post-MVP)\n\n### Rate Limiting\n- 1 req/s to Telegram API\n- 100 channels per cycle\n- Priority: NULLS FIRST (never updated)\n\n### Error Handling\n- Channel not found (400): is_active = false\n- Rate limit (429): exponential backoff, skip\n- 10+ consecutive failures: disable auto-update\n\n### DDL\n- ALTER TABLE channels ADD COLUMN avg_views, engagement_rate, stats_updated_at\n- CREATE INDEX idx_channels_stats_updated\n\n### Metrics\n- marketplace.channel.stats.updates{status}\n- marketplace.channel.stats.age\n\n## Подсказки\n- Low priority (P3) — не критично для MVP flow\n- Зависит от: Channel Service","status":"open","priority":3,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T11:13:13.407174+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:13:13.407174+03:00","labels":["marketplace","phase-4","stats"],"dependencies":[{"issue_id":"advert-market-tj7.4","depends_on_id":"advert-market-tj7","type":"parent-child","created_at":"2026-02-12T11:13:13.408389+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.4","depends_on_id":"advert-market-6wx.1","type":"blocks","created_at":"2026-02-12T11:16:40.082652+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-tj7.5","title":"Channel Admin List Monitoring (periodic)","description":"Периодическая проверка что owner всё ещё admin канала + мониторинг изменений.\n\n## Предпосылки\nOwner может потерять контроль над каналом (удалён как admin, передал ownership).\nНужно периодически проверять и деактивировать листинг.\n\n## Что реализовать\n\n### marketplace-impl (расширение ChannelStatisticsCollector)\nДобавить в цикл обновления статистики:\n1. getChatAdministrators(channelId) → List\u003cChatMemberInfo\u003e\n2. Найти owner_user_id в списке\n3. Если owner НЕ в списке админов:\n   - Деактивировать канал\n   - Уведомить owner: CHANNEL_OWNERSHIP_LOST\n   - Если есть активные deals: alert operator\n4. Проверить что бот всё ещё admin с нужными правами\n5. Обновить channels.bot_verified_at\n\n### Расширение Channel Stats Collector\n- Добавить admin check в тот же @Scheduled цикл\n- Rate limit: getChatAdministrators тяжелее getChatMemberCount\n- Frequency: 1 раз в 24h (реже чем stats)\n\n### Notification Templates\n- notification.CHANNEL_OWNERSHIP_LOST: \"Вы больше не являетесь администратором канала {channel_title}.\"\n\n### Metrics\n- channel.admin.check{result=PASS|FAIL_OWNER_REMOVED|FAIL_BOT_REMOVED}\n\n## Подсказки\n- Low priority (P3) — edge case, но важно для trust\n- Зависит от: Telegram Channel API, Channel Service, Channel Stats Collector\n- getChatAdministrators возвращает всех админов — может быть дорогой запрос","status":"open","priority":3,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T11:31:01.787757+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:31:01.787757+03:00","labels":["admin","marketplace","monitoring","phase-4"],"dependencies":[{"issue_id":"advert-market-tj7.5","depends_on_id":"advert-market-tj7","type":"parent-child","created_at":"2026-02-12T11:31:01.788482+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.5","depends_on_id":"advert-market-6wx.6","type":"blocks","created_at":"2026-02-12T11:31:16.119025+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.5","depends_on_id":"advert-market-6wx.1","type":"blocks","created_at":"2026-02-12T11:31:16.238113+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-tj7.5","depends_on_id":"advert-market-tj7.4","type":"blocks","created_at":"2026-02-12T11:31:16.350629+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-ubx","title":"Project Scaffold \u0026 Docker Compose","description":"build.gradle.kts (Kotlin 2.2, Spring Boot 4.0, Spring Kafka, jOOQ, Redis, PostgreSQL), docker-compose.yml (PostgreSQL 18, Redis 8, Kafka 4.1 KRaft), application.yml with dev/test/prod profiles.","acceptance_criteria":"build.gradle.kts compiles; docker-compose up starts all infra; application.yml profiles; Health checks; README with setup","status":"closed","priority":0,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-11T01:37:14.469774+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:29.597656+03:00","closed_at":"2026-02-11T02:32:29.597656+03:00","close_reason":"Implementation spec files created in .memory-bank/14-implementation-specs/","labels":["devops","infrastructure","setup"]}
{"id":"advert-market-uf2","title":"Acceptance Criteria","description":"- SDK chosen with Maven/Gradle coordinates","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.504475+03:00","updated_at":"2026-02-11T01:36:35.717179+03:00","closed_at":"2026-02-11T01:36:35.717179+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-uyo","title":"TON Center API Endpoint Catalog","description":"Document TON Center API: exact endpoint URLs (testnet v2/v3), request/response payloads for getTransactions/sendBoc/getAddressBalance, API key format, rate limiting, error responses, timeout handling.","acceptance_criteria":"All endpoints documented with URL/method/headers; Request/response JSON examples; Rate limit values; Error codes; Testnet vs mainnet config","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:38:05.65233+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.508077+03:00","closed_at":"2026-02-11T02:32:42.508077+03:00","close_reason":"Implementation spec files created","labels":["api","integration","ton"],"dependencies":[{"issue_id":"advert-market-uyo","depends_on_id":"advert-market-4iq","type":"blocks","created_at":"2026-02-11T01:45:34.093196+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-xo8","title":"ABAC Policy Rules — Spring Security Mapping","description":"Map ABAC policies to Spring Security: custom @PreAuthorize or SpEL, policy decision point, attribute loading optimization (request-scoped cache), PermissionEvaluator for deal/channel/operator actions.","acceptance_criteria":"Spring Security filter chain; @PreAuthorize expressions per action; PermissionEvaluator pattern; Attribute caching; Integration test examples","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":90,"created_at":"2026-02-11T01:38:06.222236+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.514642+03:00","closed_at":"2026-02-11T02:32:42.514642+03:00","close_reason":"Implementation spec files created","labels":["abac","auth","security"],"dependencies":[{"issue_id":"advert-market-xo8","depends_on_id":"advert-market-b2k","type":"blocks","created_at":"2026-02-11T01:46:05.896851+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-xyr","title":"Acceptance Criteria","description":"- Key storage mechanism chosen per environment","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.506392+03:00","updated_at":"2026-02-11T01:36:35.308632+03:00","closed_at":"2026-02-11T01:36:35.308632+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-y1c","title":"Enable Checker Framework annotation processor for compile-time nullness/fenum enforcement","status":"open","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T21:59:15.709522+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:59:15.709522+03:00"}
{"id":"advert-market-y2b","title":"Inter-Module Interaction Architecture (ports \u0026 adapters)","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:31.347684+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:18:00.990235+03:00","closed_at":"2026-02-12T21:18:00.990235+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["architecture","modules","phase-1"],"dependencies":[{"issue_id":"advert-market-y2b","depends_on_id":"advert-market-z8x","type":"blocks","created_at":"2026-02-12T11:51:22.118136+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-y4p","title":"[H-4] CanaryRouter — port violation + non-atomic + metrics bypass","description":"Direct StringRedisTemplate, two separate GETs, Counter.builder() instead of MetricsFacade.","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T23:26:47.706847+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-13T00:30:22.672635+03:00","closed_at":"2026-02-13T00:30:22.672635+03:00","close_reason":"Fixed in commit 94b0011"}
{"id":"advert-market-ypj","title":"Acceptance Criteria","description":"- Lock acquire/release code with Lua scripts","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.506892+03:00","updated_at":"2026-02-11T01:36:35.161392+03:00","closed_at":"2026-02-11T01:36:35.161392+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-yqw","title":"Deal Timeout Scheduler Implementation","description":"Scheduler technology (Spring Scheduler vs Quartz), deadline storage/querying, timeout config per state, grace period handling, deal.deadlines Kafka topic message format.","acceptance_criteria":"Scheduler chosen; Deadline storage in deals.deadline_at; Kafka message format; Configurable timeouts; Grace period rules","status":"closed","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":45,"created_at":"2026-02-11T01:38:42.040049+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:56.368673+03:00","closed_at":"2026-02-11T02:32:56.368673+03:00","close_reason":"Implementation spec files created","labels":["deals","scheduling","workers"]}
{"id":"advert-market-z4o","title":"Redis Distributed Lock Implementation","description":"SET NX EX with fencing token, lock release Lua script, deadlock/stale cleanup, lock acquisition timeout, Redis client choice (Lettuce vs Jedis), Redlock for Scaled.","acceptance_criteria":"Lock acquire/release Lua scripts; Fencing token algorithm; Stale lock cleanup; Timeout values per operation; Redis client chosen","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:38:05.771837+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.509343+03:00","closed_at":"2026-02-11T02:32:42.509343+03:00","close_reason":"Implementation spec files created","labels":["financial","idempotency","redis"],"dependencies":[{"issue_id":"advert-market-z4o","depends_on_id":"advert-market-ubx","type":"blocks","created_at":"2026-02-11T01:45:34.301959+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z76","title":"Partition Automation (ledger_entries, outbox)","status":"open","priority":3,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T11:50:29.554832+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:50:29.554832+03:00","labels":["database","partitioning","phase-5"],"dependencies":[{"issue_id":"advert-market-z76","depends_on_id":"advert-market-4fr","type":"blocks","created_at":"2026-02-12T11:51:20.001763+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x","title":"Phase 1: Foundation","description":"Core infrastructure completion: shared kernel models, auth, ABAC, Kafka schemas, Redis locks, logging. Prerequisite for all other phases.","design":"Modules: shared, identity-api, identity, app. Specs: 03, 04, 06, 09, 12, 13, 36","status":"open","priority":0,"issue_type":"epic","owner":"lonelymoonstalker@gmail.com","created_at":"2026-02-12T10:44:08.424974+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:44:08.424974+03:00","labels":["foundation","phase-1"]}
{"id":"advert-market-z8x.1","title":"Shared Kernel Models","description":"Создать базовые модели shared kernel в модуле advert-market-shared.\n\n## Specs\n- .memory-bank/14-implementation-specs/06-project-scaffold.md (shared kernel section)\n- .memory-bank/07-financial-system/05-account-types.md\n- .memory-bank/07-financial-system/07-entry-type-catalog.md\n- .memory-bank/06-deal-state-machine.md\n\n## Что реализовать\n\n### Value Objects (records)\n- `Money(long nanoTon)` — обёртка над nanoTON, арифметика\n- `DealId(UUID value)` — типизированный ID сделки\n- `UserId(long value)` — Telegram user ID\n- `ChannelId(long value)` — Telegram channel ID\n- `AccountId(String value)` — ID финансового аккаунта (например \"ESCROW:{dealId}\")\n\n### Enums\n- `DealStatus` — 16 состояний: DRAFT, OFFER_PENDING, NEGOTIATING, ACCEPTED, AWAITING_PAYMENT, FUNDED, CREATIVE_SUBMITTED, CREATIVE_APPROVED, SCHEDULED, PUBLISHED, DELIVERY_VERIFYING, COMPLETED_RELEASED, DISPUTED, CANCELLED, REFUNDED, PARTIALLY_REFUNDED, EXPIRED\n- `AccountType` — PLATFORM_TREASURY, EXTERNAL_TON, NETWORK_FEES, DUST_WRITEOFF, ESCROW, COMMISSION, OVERPAYMENT, PARTIAL_DEPOSIT, LATE_DEPOSIT, OWNER_PENDING\n- `EntryType` — ESCROW_DEPOSIT, PARTIAL_DEPOSIT, ESCROW_RELEASE, OWNER_PAYOUT, PLATFORM_COMMISSION, ESCROW_REFUND, PARTIAL_REFUND, OVERPAYMENT_REFUND, LATE_DEPOSIT_REFUND, COMMISSION_SWEEP, OWNER_WITHDRAWAL, NETWORK_FEE, REVERSAL, DUST_WRITEOFF\n- `ActorType` — ADVERTISER, CHANNEL_OWNER, CHANNEL_MANAGER, OPERATOR, SYSTEM\n\n### Events\n- `EventEnvelope\u003cT\u003e` record — event_id, event_type, deal_id, timestamp, version, correlation_id, payload\n- `DomainEvent` sealed interface\n\n### Exceptions\n- `DomainException` — base\n- `EntityNotFoundException`\n- `InvalidStateTransitionException`\n- `InsufficientBalanceException`\n\n### Pagination\n- `CursorPage\u003cT\u003e` record — items, nextCursor, hasNext\n- `CursorCodec` — Base64 encode/decode keyset cursor\n\n### Util\n- `IdempotencyKey` record","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":240,"created_at":"2026-02-12T10:45:11.986901+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T13:33:24.018928+03:00","closed_at":"2026-02-12T13:33:24.018928+03:00","close_reason":"18 production + 17 test files implemented, Codex reviewed, pushed to main (953a01a)","labels":["models","phase-1","shared"],"dependencies":[{"issue_id":"advert-market-z8x.1","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:45:11.987565+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.10","title":"Testing Strategy Infrastructure","description":"Test infrastructure: Testcontainers base, test data builders, ArchUnit rules.\n\n## Specs\n- .memory-bank/14-implementation-specs/26-testing-strategy.md\n\n## Что реализовать\n\n### integration-tests module\n- AbstractIntegrationTest: base class с Testcontainers (PostgreSQL, Redis, Kafka)\n  - @SpringBootTest + @Testcontainers\n  - Shared containers (reuse across tests)\n  - Liquibase auto-migration\n  - jOOQ DSLContext injection\n\n### Test Data Builders (shared-test или integration-tests)\n- TestDealBuilder: .withStatus(FUNDED).withAmount(1_000_000_000L).build()\n- TestUserBuilder: .withId(123L).withUsername(\"test\").build()\n- TestChannelBuilder: .withOwner(userId).withSubscribers(10000).build()\n- TestLedgerEntryBuilder: .escrowDeposit(dealId, amountNano).build()\n\n### ArchUnit Rules (integration-tests)\n- Module dependency rules:\n  - financial-impl MUST NOT depend on deal/marketplace/delivery/communication\n  - *-impl MUST NOT depend on other *-impl (only via *-api)\n  - shared MUST NOT depend on any module\n- Naming conventions:\n  - @Service classes end with Service\n  - @Repository classes end with Repository\n  - Port interfaces end with Port\n\n### Test Categories\n- @Tag(\"unit\") — unit tests (no Spring context)\n- @Tag(\"integration\") — Testcontainers\n- @Tag(\"architecture\") — ArchUnit\n\n### Gradle\n- test task: runs unit + architecture\n- integrationTest task: runs integration tests (separate source set)\n\n## Подсказки\n- Testcontainers 2.0.3 (новый API)\n- @DisplayName required на всех тестах\n- ArchUnit 1.4.1: ArchRule → .check(importedClasses)\n- Зависит от: Shared Kernel (для test builders)","status":"closed","priority":2,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T11:36:49.679757+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.273886+03:00","closed_at":"2026-02-12T21:17:52.273886+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["cross-cutting","testing"],"dependencies":[{"issue_id":"advert-market-z8x.10","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T11:36:49.682038+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.10","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:37:43.767845+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.2","title":"Error Code Catalog + Global Exception Handler","description":"RFC 7807 Problem Details + i18n error messages.\n\n## Specs\n- .memory-bank/14-implementation-specs/12-error-code-catalog.md\n\n## Что реализовать\n\n### ErrorCode enum (shared)\n8 категорий: AUTH_* (8), DEAL_* (5), FIN_* (7), CHAN_* (6), DISP_* (4), CRTV_* (4), VAL_* (3), SYS_* (5)\nКаждый код маппится на HTTP status.\n\n### ProblemDetail record (shared)\ntype, title, status, detail, instance, error_code, timestamp, correlation_id\n\n### GlobalExceptionHandler (app)\n@ControllerAdvice — маппинг DomainException → ProblemDetail.\nОбработка: ConstraintViolationException, MethodArgumentNotValid, HttpMessageNotReadable.\n\n### i18n\nmessages/errors_ru.properties, errors_en.properties — MessageSource.\n\n## Подсказки\n- Spring Boot 4 поддерживает RFC 7807 нативно (ProblemDetail)\n- HttpMessageNotReadableException вместо JsonParseException (Jackson 3.x)\n- correlation_id из MDC","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T10:45:23.947867+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T16:29:19.85918+03:00","closed_at":"2026-02-12T16:29:19.85918+03:00","close_reason":"Error Code Catalog + Global Exception Handler fully implemented","labels":["errors","phase-1","shared"],"dependencies":[{"issue_id":"advert-market-z8x.2","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:45:23.948527+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.2","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:16:07.25228+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.3","title":"Kafka Event Schemas + Consumer Infrastructure","description":"JSON Schema сериализация, event envelope, 8 топиков, DLT стратегия.\n\n## Specs\n- .memory-bank/14-implementation-specs/04-kafka-event-schemas.md\n- .memory-bank/14-implementation-specs/18-kafka-consumer-error-handling.md\n\n## Что реализовать\n\n### Event Envelope (shared)\nKafkaEvent\u003cT\u003e record: event_id(UUID), event_type(String), deal_id(UUID), timestamp(Instant), version(int), correlation_id(String), payload(T)\nJackson сериализация/десериализация.\n\n### Event Types (shared, по топикам)\n1. deal.events: DealStateChangedEvent\n2. escrow.commands: WatchDepositCommand, ExecutePayoutCommand, ExecuteRefundCommand\n3. escrow.confirmations: DepositConfirmedEvent, DepositFailedEvent\n4. delivery.commands: PublishPostCommand, VerifyDeliveryCommand\n5. delivery.results: DeliveryVerifiedEvent, DeliveryFailedEvent\n6. notifications.outbox: NotificationEvent\n7. reconciliation.triggers: ReconciliationStartEvent\n8. deal.deadlines: DeadlineSetEvent\n\n### Consumer Infrastructure (app)\n- Spring Kafka config: idempotence, manual commit (MANUAL_IMMEDIATE)\n- DefaultErrorHandler с retry policy (3 retries default, 5 для financial)\n- ErrorHandlingDeserializer wrapper\n- DLT naming: {topic}.DLT\n- CooperativeStickyAssignor\n\n### Topic Configuration (app)\n8 топиков + DLT для каждого (docker-compose и KafkaAdmin beans).\n\n## Подсказки\n- Spring Kafka 4.x: ConcurrentKafkaListenerContainerFactory\n- Offset commit: ack-mode MANUAL_IMMEDIATE (at-least-once + idempotency = exactly-once)\n- Consumer groups: 10 групп (см. spec 18)","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":300,"created_at":"2026-02-12T10:45:35.99119+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.270589+03:00","closed_at":"2026-02-12T21:17:52.270589+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["kafka","phase-1","shared"],"dependencies":[{"issue_id":"advert-market-z8x.3","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:45:35.991871+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.3","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:16:07.364622+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.4","title":"Redis Distributed Locks + Idempotency Service","description":"Lettuce-based distributed locks, Lua scripts, idempotency keys.\n\n## Specs\n- .memory-bank/14-implementation-specs/09-redis-distributed-locks.md\n\n## Что реализовать\n\n### DistributedLockService (shared)\n- acquireLock(resource, ttl) → FencingToken\n- releaseLock(resource, fencingToken) — Lua script для safe release\n- tryAcquireLock() с timeout и retry\n- FencingToken record (UUID)\n- LockAcquisitionException\n\n### Lock Keys\n- lock:deal:{deal_id} (30s), lock:payout:{deal_id} (60s), lock:refund:{deal_id} (60s)\n- lock:deposit:{deal_id} (30s), lock:balance:{account_id} (10s)\n- lock:outbox:poller (30s), lock:reconciliation (300s)\n\n### IdempotencyService (shared)\n- checkAndSet(operation, uniqueKey) → boolean (SET NX EX)\n- Keys: idempotency:deposit:{tx_hash} (24h), idempotency:payout:{deal_id}, etc.\n\n### Lua Scripts\n- release_lock.lua — CHECK owner THEN DEL\n- Загрузка через RedisScript\u003cBoolean\u003e\n\n### Configuration\n- LockProperties record: default-ttl, acquisition-timeout, retry-interval\n\n## Подсказки\n- Lettuce (не Jedis) — уже в стеке\n- FencingToken = UUID, проверяем при release\n- Port interface: DistributedLockPort","status":"closed","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":180,"created_at":"2026-02-12T10:45:46.516664+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.266164+03:00","closed_at":"2026-02-12T21:17:52.266164+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["phase-1","redis","shared"],"dependencies":[{"issue_id":"advert-market-z8x.4","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:45:46.517309+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.5","title":"Auth Flow: JWT + Telegram initData","description":"Telegram Mini App аутентификация + JWT сессии + auto-registration.\n\n## Specs\n- .memory-bank/14-implementation-specs/03-auth-flow.md\n\n## Что реализовать\n\n### identity-api\n- AuthPort interface: login(initData) → AuthResult\n- AuthResult record: accessToken, expiresIn, user\n- UserDto record: id, firstName, lastName, username, languageCode\n\n### identity-impl\n- TelegramInitDataValidator: HMAC-SHA256 валидация initData\n  1. Парсинг query string\n  2. data_check_string (sorted key=value, без hash)\n  3. secret_key = HMAC-SHA256(bot_token, \"WebAppData\")\n  4. hash = HMAC-SHA256(secret_key, data_check_string)\n  5. Проверка auth_date (anti-replay window)\n- JwtService: создание/парсинг JWT (JJWT 0.13.0)\n  - Claims: sub=userId, iat, exp, firstName, username\n- JwtAuthenticationFilter extends OncePerRequestFilter\n  - Извлекает Bearer token → TelegramAuthentication\n- TelegramAuthentication implements Authentication\n- UserRegistrationService: upsert user при первом логине\n  - INSERT INTO users ON CONFLICT (telegram_id) DO UPDATE\n\n### REST API\n- POST /api/v1/auth/login — принимает {initData: \"...\"}, возвращает JWT\n\n### Configuration\n- AuthProperties record: jwt.secret, jwt.expiry (1h), anti-replay-window (300s)\n- SecurityFilterChain bean в app модуле\n\n## Подсказки\n- Spring Security 7 (Spring Boot 4): SecurityFilterChain вместо WebSecurityConfigurerAdapter\n- Redis blacklist для revoked tokens (опционально для MVP)\n- Тесты: mock initData с правильным HMAC","status":"closed","priority":0,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":360,"created_at":"2026-02-12T10:46:02.868353+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T16:43:41.820346+03:00","closed_at":"2026-02-12T16:43:41.820346+03:00","close_reason":"Auth Flow implemented: JWT + Telegram initData HMAC-SHA256, 27 tests, all checks pass","labels":["auth","identity","phase-1"],"dependencies":[{"issue_id":"advert-market-z8x.5","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:46:02.869006+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.5","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:16:07.491451+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.5","depends_on_id":"advert-market-z8x.2","type":"blocks","created_at":"2026-02-12T11:16:07.600441+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.6","title":"ABAC Spring Security","description":"Attribute-Based Access Control через @PreAuthorize SpEL expressions.\n\n## Specs\n- .memory-bank/14-implementation-specs/13-abac-spring-security.md\n- .memory-bank/05-patterns-and-decisions/08-abac.md\n\n## Что реализовать\n\n### UserAttributeContext (@RequestScope, identity)\n- userId, isOperator\n- getMembership(channelId) — кеширование в рамках запроса\n- Lazy loading из БД при первом обращении\n\n### Authorization Beans (identity)\n- DealAuthorizationService (@Component \\\"dealAuth\\\")\n  - isParticipant(dealId), isAdvertiser(dealId), isOwner(dealId), channelId(dealId)\n- ChannelAuthorizationService (@Component \\\"channelAuth\\\")\n  - isOwner(channelId), hasRight(channelId, right)\n- AuthorizationService (@Component \\\"auth\\\")\n  - isOperator()\n\n### ChannelMembership (identity-api)\n- ChannelMembership record: userId, channelId, role(OWNER/MANAGER), rights(JSONB)\n- Rights: moderate, publish, manage_team, view_stats\n\n### SecurityFilterChain (app)\n- @EnableMethodSecurity(prePostEnabled = true)\n- Маппинг @PreAuthorize на все endpoints:\n  - @PreAuthorize(\\\"@dealAuth.isParticipant(#dealId)\\\")\n  - @PreAuthorize(\\\"@channelAuth.isOwner(#channelId)\\\")\n  - @PreAuthorize(\\\"@auth.isOperator()\\\")\n\n## Подсказки\n- Зависит от Auth Flow (JWT filter + TelegramAuthentication)\n- NO fixed roles — разрешения вычисляются из channel_memberships\n- Тесты: @WithMockUser + mock authorization beans","status":"closed","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":240,"created_at":"2026-02-12T10:46:13.795975+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.268173+03:00","closed_at":"2026-02-12T21:17:52.268173+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["abac","identity","phase-1"],"dependencies":[{"issue_id":"advert-market-z8x.6","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:46:13.796696+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.6","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:16:07.705031+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.7","title":"Structured Logging + MDC","description":"Structured JSON logging, MDC context propagation, PII redaction.\n\n## Specs\n- .memory-bank/14-implementation-specs/36-logging-strategy.md\n\n## Что реализовать\n\n### Logback Configuration (app)\n- logstash-logback-encoder для JSON output\n- MDC fields: correlation_id, user_id, deal_id, trace_id\n\n### MDC Filter (app)\n- Spring filter: X-Correlation-Id header → MDC (или генерация UUID)\n- JWT claims → MDC (user_id)\n- Clear MDC on request completion\n\n### PII Redaction\n- Custom PatternLayout: маскировка TON addresses, JWT tokens\n- EQ...***...abc для адресов, eyJ*** для токенов\n\n### Log Levels (Production)\n- com.advertmarket: INFO\n- com.advertmarket.financial: INFO (audit)\n- org.springframework: WARN\n- org.jooq: WARN\n\n### Business Event Markers\n- [FINANCIAL], [DEAL], [SECURITY] — маркеры для grep/alerting\n\n## Подсказки\n- logstash-logback-encoder уже в зависимостях (проверить)\n- Lombok @Slf4j на всех классах\n- Kafka consumer: пробрасывать correlation_id через headers","status":"open","priority":2,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T10:46:20.025983+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T10:46:20.025983+03:00","labels":["cross-cutting","logging","phase-1"],"dependencies":[{"issue_id":"advert-market-z8x.7","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T10:46:20.027957+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.8","title":"Worker Callback Controller + Schemas","description":"Internal API для workers: callback endpoint + typed payload schemas.\n\n## Specs\n- .memory-bank/14-implementation-specs/10-worker-callback-schemas.md\n\n## Предпосылки\nWorkers (deposit watcher, payout executor, delivery verifier) должны сообщать \nрезультаты обратно в main app. Нужен unified internal endpoint.\n\n## Что реализовать\n\n### shared\n- WorkerCallbackType enum: DEPOSIT_CONFIRMED, DEPOSIT_FAILED, PAYOUT_COMPLETED, PAYOUT_FAILED, REFUND_COMPLETED, REFUND_FAILED, POST_PUBLISHED, POST_PUBLISH_FAILED, DELIVERY_VERIFIED, DELIVERY_FAILED\n- WorkerCallback\u003cT\u003e record: callbackType, dealId, timestamp, correlationId, payload(T)\n- Typed payloads (records):\n  - DepositConfirmedPayload: txHash, amountNano, confirmations, fromAddress\n  - PayoutCompletedPayload: txHash, amountNano, feeNano, toAddress\n  - DeliveryVerifiedPayload: messageId, checksPassed, contentHash\n  - (и другие по spec 10)\n\n### app (REST controller)\n- POST /internal/v1/worker-events — unified callback endpoint\n  - Internal only (не через public API gateway)\n  - Dispatch by callbackType → соответствующий handler\n  - Idempotency: по correlationId\n\n### Routing\n- WorkerCallbackDispatcher: routes to module-specific handlers\n  - DEPOSIT_* → EscrowPort (financial)\n  - PAYOUT_*, REFUND_* → PayoutPort (financial)\n  - POST_*, DELIVERY_* → DeliveryPort (deal)\n\n## Подсказки\n- Internal API: отдельный SecurityFilterChain (no JWT, IP whitelist или shared secret)\n- Зависит от: Shared Kernel (z8x.1)\n- Используется: TON SDK (av4.2), Payout (av4.4), Post Scheduler (tj7.1), Delivery Verifier (tj7.2)","status":"open","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":120,"created_at":"2026-02-12T11:36:43.857338+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T11:36:43.857338+03:00","labels":["callbacks","phase-1","shared","workers"],"dependencies":[{"issue_id":"advert-market-z8x.8","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T11:36:43.858097+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.8","depends_on_id":"advert-market-z8x.1","type":"blocks","created_at":"2026-02-12T11:37:43.327919+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-z8x.9","title":"OpenAPI Spec + TypeScript Codegen","description":"springdoc-openapi для auto-generated spec + TypeScript client generation.\n\n## Specs\n- .memory-bank/11-api-contracts.md (OpenAPI code-first approach)\n- .memory-bank/17-typescript-conventions.md\n\n## Предпосылки\nБез этого фронтенд пишет API-клиенты вручную — дублирование, рассинхрон типов.\n\n## Что реализовать\n\n### Backend (app module)\n- springdoc-openapi 3.0.1 (уже в зависимостях)\n- OpenApiConfig: info, servers, security schemes\n- Экспорт: GET /v3/api-docs → openapi.json\n- Gradle task: generateOpenApiSpec (запуск приложения → dump spec)\n- @Tag, @Operation, @ApiResponse аннотации на контроллерах\n\n### Frontend (frontend module)\n- openapi-typescript-codegen или orval\n- Gradle task: generateTsClient (зависит от generateOpenApiSpec)\n- Output: frontend/src/shared/api/generated/\n- Конфиг: customFetch с JWT Bearer header\n\n### CI Integration\n- GitHub Actions: backend build → generate spec → generate TS → frontend build\n- Spec file committed: frontend/openapi.json (для standalone frontend builds)\n\n## Подсказки\n- Spring Boot 4 + springdoc 3.x: jakarta.* namespace\n- OpenApiConfig уже существует в app/config/ — расширить\n- Зависит от: любой REST controller (можно начать с Auth endpoint)","status":"closed","priority":1,"issue_type":"feature","owner":"lonelymoonstalker@gmail.com","estimated_minutes":90,"created_at":"2026-02-12T11:36:46.535894+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-12T21:17:52.272361+03:00","closed_at":"2026-02-12T21:17:52.272361+03:00","close_reason":"Code fully implemented, verified by git history and source scan","labels":["app","frontend","openapi","phase-1"],"dependencies":[{"issue_id":"advert-market-z8x.9","depends_on_id":"advert-market-z8x","type":"parent-child","created_at":"2026-02-12T11:36:46.540869+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-z8x.9","depends_on_id":"advert-market-z8x.5","type":"blocks","created_at":"2026-02-12T11:37:43.558895+03:00","created_by":"Nikita Kochnev"}]}
{"id":"advert-market-zex","title":"Acceptance Criteria","description":"- Bot framework chosen with dependency coordinates","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-11T01:35:16.505071+03:00","updated_at":"2026-02-11T01:36:35.647742+03:00","closed_at":"2026-02-11T01:36:35.647742+03:00","close_reason":"duplicate - recreating with correct titles"}
{"id":"advert-market-zom","title":"Outbox Poller Implementation Spec","description":"Polling interval/batch size, FOR UPDATE SKIP LOCKED query, Kafka producer error handling, outbox record lifecycle (PENDING-\u003eDELIVERED/FAILED), cleanup/archival, DLQ.","acceptance_criteria":"Polling SQL with SKIP LOCKED; Batch config; Kafka produce failure handling; Cleanup strategy; Monitoring metrics","status":"closed","priority":1,"issue_type":"task","owner":"lonelymoonstalker@gmail.com","estimated_minutes":60,"created_at":"2026-02-11T01:38:06.007745+03:00","created_by":"Nikita Kochnev","updated_at":"2026-02-11T02:32:42.512232+03:00","closed_at":"2026-02-11T02:32:42.512232+03:00","close_reason":"Implementation spec files created","labels":["infrastructure","kafka","outbox"],"dependencies":[{"issue_id":"advert-market-zom","depends_on_id":"advert-market-3mw","type":"blocks","created_at":"2026-02-11T01:46:05.751135+03:00","created_by":"Nikita Kochnev"},{"issue_id":"advert-market-zom","depends_on_id":"advert-market-9te","type":"blocks","created_at":"2026-02-11T01:46:05.824126+03:00","created_by":"Nikita Kochnev"}]}
