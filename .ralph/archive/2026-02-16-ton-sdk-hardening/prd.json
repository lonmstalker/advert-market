{
  "project": "advert-market",
  "branchName": "ralph/av4.2-ton-sdk-hardening",
  "description": "TON SDK Integration Hardening — fix 3 CRITICAL bugs (race condition, NPE, secret leak), 5 HIGH bugs (overflow, validation), and add missing tests. TDD approach: RED test first, then GREEN fix.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix race condition in updateConfirmed — add CAS version check",
      "description": "As a platform operator, I need deposit confirmation to be atomic so that double-spend is impossible.",
      "acceptanceCriteria": [
        "RED: Write test `shouldNotConfirmSameDepositTwice_concurrentCAS` in `JooqTonTransactionRepositoryTest` — call `updateConfirmed()` twice with same id and same expectedVersion, assert second call returns false",
        "GREEN: Add `int expectedVersion` parameter to `JooqTonTransactionRepository.updateConfirmed()`, add `.and(TON_TRANSACTIONS.VERSION.eq(expectedVersion))` to WHERE clause, set VERSION to `expectedVersion + 1`",
        "Update `DepositWatcher.confirmDeposit()` to pass `record.getVersion()` into `updateConfirmed()`",
        "If `updateConfirmed()` returns false, log WARN 'Deposit id={} already confirmed by another instance' and skip event publication — do NOT throw",
        "All existing DepositWatcherTest tests pass",
        "Tests pass"
      ],
      "priority": 1,
      "passes": false,
      "notes": "CRITICAL: prevents double-spend. Files: JooqTonTransactionRepository.java, DepositWatcher.java, JooqTonTransactionRepositoryTest.java, DepositWatcherTest.java"
    },
    {
      "id": "US-002",
      "title": "Filter null txHash and null inMsg from TON Center response",
      "description": "As a developer, I need blockchain data validated at boundary so null txHash never reaches domain logic.",
      "acceptanceCriteria": [
        "RED: Write test `shouldFilterOutTransactionsWithNullTxHash` in `TonCenterBlockchainAdapterTest` — response with txId.hash=null should be excluded from result list",
        "RED: Write test `shouldFilterOutTransactionsWithNullInMsg` — response with inMsg=null should be excluded",
        "GREEN: In `TonCenterBlockchainAdapter.getTransactions()`, add `.filter(tx -> tx.getTransactionId() != null && tx.getTransactionId().getHash() != null)` before `.map()`",
        "GREEN: Add `.filter(tx -> tx.getInMsg() != null)` before `.map()`",
        "Log WARN for each filtered transaction: 'Skipping TON transaction with missing txHash/inMsg'",
        "All existing TonCenterBlockchainAdapterTest tests pass",
        "Tests pass"
      ],
      "priority": 2,
      "passes": false,
      "notes": "CRITICAL: prevents NPE. File: TonCenterBlockchainAdapter.java, TonCenterBlockchainAdapterTest.java"
    },
    {
      "id": "US-003",
      "title": "Eliminate mnemonic exposure in stack traces and logs",
      "description": "As a security engineer, I need the platform wallet mnemonic to never appear in logs, stack traces, or error messages.",
      "acceptanceCriteria": [
        "RED: Write test `shouldNotExposeMnemonicInExceptionMessage` in `TonWalletServiceTest` — call constructor with invalid mnemonic, catch exception, assert message does NOT contain the mnemonic words",
        "GREEN: In `TonWalletService.deriveKeyPair()`, catch exception and throw new `IllegalStateException(\"Failed to derive key pair from mnemonic\")` WITHOUT chaining the original exception (no `ex` in constructor)",
        "Verify `TonConfig.tonWalletService()` does NOT log the decrypted mnemonic at any level",
        "Tests pass"
      ],
      "priority": 3,
      "passes": false,
      "notes": "CRITICAL security. File: TonWalletService.java, TonConfig.java, TonWalletServiceTest.java"
    },
    {
      "id": "US-004",
      "title": "Change TonBlockchainPort.getSeqno() return type from int to long",
      "description": "As a developer, I need seqno transmitted as long to prevent overflow on high-activity wallets.",
      "acceptanceCriteria": [
        "Change `TonBlockchainPort.getSeqno(@NonNull String address)` return type from `int` to `long`",
        "Update `TonCenterBlockchainAdapter.getSeqno()` — remove `(int)` cast, return raw `long` from tonCenter",
        "Update `TonWalletService.submitTransaction()` — use `long seqno` variable",
        "Update `ResilientTonBlockchainPort.getSeqno()` delegate — return `long`",
        "Update all test mocks that stub `getSeqno()` to return `long` values",
        "All existing tests pass",
        "Tests pass"
      ],
      "priority": 4,
      "passes": false,
      "notes": "HIGH: type change across port interface. Files: TonBlockchainPort.java, TonCenterBlockchainAdapter.java, TonWalletService.java, TonConfig.java (ResilientTonBlockchainPort), all related tests"
    },
    {
      "id": "US-005",
      "title": "Fix seqno persistence for first-time deposit detection",
      "description": "As a developer, I need the first-detected block seqno to be persisted so that confirmation counting starts correctly.",
      "acceptanceCriteria": [
        "RED: Write test `shouldSaveBlockSeqnoOnFirstDetection` in `DepositWatcherTest` — deposit with seqno=null should get seqno saved after first poll, not stay null forever",
        "GREEN: In `DepositWatcher.resolveConfirmedBlocks()`, when `record.getSeqno() == null`: extract block info from `TonTransactionInfo`, save via new `txRepository.updateSeqno(id, seqno, expectedVersion)` method",
        "Add `updateSeqno(long id, long seqno, int expectedVersion)` method to `JooqTonTransactionRepository` with CAS version check",
        "After saving seqno, calculate and return `(int)(masterSeqno - savedSeqno)` in same cycle instead of returning -1",
        "All existing DepositWatcher tests pass",
        "Tests pass"
      ],
      "priority": 5,
      "passes": false,
      "notes": "HIGH: depends on US-004 (seqno is long). Files: DepositWatcher.java, JooqTonTransactionRepository.java, DepositWatcherTest.java"
    },
    {
      "id": "US-006",
      "title": "Add overflow guard for subwalletId long-to-int cast",
      "description": "As a developer, I need subwalletId safely stored so that overflow doesn't create address collisions.",
      "acceptanceCriteria": [
        "RED: Write test `shouldRejectSubwalletIdExceedingIntMax` in `EscrowServiceTest` — mock `tonWalletPort.generateDepositAddress()` returning subwalletId = Integer.MAX_VALUE + 1L, assert `IllegalStateException` is thrown",
        "GREEN: In `EscrowService.generateDepositAddress()`, add guard: `if (addressInfo.subwalletId() > Integer.MAX_VALUE) throw new IllegalStateException(\"Subwallet ID overflow: \" + addressInfo.subwalletId())`",
        "All existing EscrowService tests pass",
        "Tests pass"
      ],
      "priority": 6,
      "passes": false,
      "notes": "HIGH. File: EscrowService.java, EscrowServiceTest.java"
    },
    {
      "id": "US-007",
      "title": "Validate positive amount in DepositWatcher matching",
      "description": "As a platform operator, I need deposits with zero or negative amounts rejected so invalid blockchain data doesn't create false confirmations.",
      "acceptanceCriteria": [
        "RED: Write test `shouldNotMatchTransactionWithZeroAmount` in `DepositWatcherTest` — TX with amountNano=0 should not be matched",
        "RED: Write test `shouldNotMatchTransactionWithNegativeAmount` — TX with amountNano=-1 should not be matched",
        "GREEN: In `DepositWatcher.findMatchingTx()`, add `tx.amountNano() > 0` to the stream filter predicate",
        "All existing DepositWatcher tests pass",
        "Tests pass"
      ],
      "priority": 7,
      "passes": false,
      "notes": "HIGH. File: DepositWatcher.java, DepositWatcherTest.java"
    },
    {
      "id": "US-008",
      "title": "Handle duplicate TX in getTransactions matching — pick most recent by lt",
      "description": "As a developer, I need deposit matching to pick the correct transaction when TON Center returns multiple TXs.",
      "acceptanceCriteria": [
        "RED: Write test `shouldSelectMostRecentTransactionByLt` in `DepositWatcherTest` — when 2 TXs match amount filter, the one with higher `lt` is selected",
        "GREEN: Replace `.findFirst()` with `.max(Comparator.comparingLong(TonTransactionInfo::lt))` in `DepositWatcher.findMatchingTx()`",
        "RED: Write test `shouldExcludeAlreadyProcessedTxHashes` — TX with txHash already in ton_transactions DB should not be matched",
        "GREEN: Before matching, load existing txHashes from `txRepository` for the deposit address and filter them out",
        "All existing DepositWatcher tests pass",
        "Tests pass"
      ],
      "priority": 8,
      "passes": false,
      "notes": "HIGH. Files: DepositWatcher.java, DepositWatcherTest.java"
    },
    {
      "id": "US-009",
      "title": "Add retry_count column and failure escalation for deposits",
      "description": "As a platform operator, I need failed deposit processing attempts tracked so permanently broken deposits are escalated.",
      "acceptanceCriteria": [
        "Create DB migration `017-ton-transaction-retry-count.sql`: ALTER TABLE ton_transactions ADD COLUMN retry_count INTEGER NOT NULL DEFAULT 0",
        "Add `retry_count` field to jOOQ generated class (regenerate or add manually to match schema)",
        "Add `maxRetries` property to `TonProperties.Deposit` with @DefaultValue(\"5\")",
        "RED: Write test `shouldMarkDepositAsFailedAfterMaxRetries` in `DepositWatcherTest`",
        "GREEN: In `processOneSafely()` catch block: increment retry_count via repository, if retry_count >= maxRetries then updateStatus to FAILED and increment metric `ton.deposit.permanently_failed`",
        "Add `incrementRetryCount(long id)` method to `JooqTonTransactionRepository`",
        "Tests pass"
      ],
      "priority": 9,
      "passes": false,
      "notes": "MEDIUM. Files: new migration SQL, TonProperties.java, DepositWatcher.java, JooqTonTransactionRepository.java, DepositWatcherTest.java"
    },
    {
      "id": "US-010",
      "title": "Normalize wallet address format for seqno queries",
      "description": "As a developer, I need consistent address formats when querying TON Center API.",
      "acceptanceCriteria": [
        "RED: Write test `shouldUseConsistentAddressFormatForSeqnoQuery` in `TonWalletServiceTest` — verify the address passed to `blockchainPort.getSeqno()` uses raw format",
        "GREEN: In `TonWalletService.submitTransaction()`, replace `wallet.getAddress().toBounceable()` with `wallet.getAddress().toString()` for seqno query",
        "All existing TonWalletService tests pass",
        "Tests pass"
      ],
      "priority": 10,
      "passes": false,
      "notes": "MEDIUM. File: TonWalletService.java, TonWalletServiceTest.java"
    },
    {
      "id": "US-011",
      "title": "Tune Circuit Breaker — separate 429 rate limit from 5xx errors",
      "description": "As a platform operator, I need the circuit breaker to tolerate TON Center rate limiting without blocking deposit monitoring.",
      "acceptanceCriteria": [
        "Create `TonRateLimitException extends RuntimeException` in `advert-market-financial` ton.client package",
        "In `TonCenterBlockchainAdapter`, detect HTTP 429 responses and throw `TonRateLimitException` instead of generic exception",
        "In `TonResilienceConfig`, configure circuit breaker with `ignoreExceptions(TonRateLimitException.class)` so 429s don't count toward failure rate",
        "RED: Write test `shouldNotCountRateLimitAsCircuitBreakerFailure` in `TonCenterBlockchainAdapterTest`",
        "GREEN: Implement the 429 detection and exception separation",
        "Tests pass"
      ],
      "priority": 11,
      "passes": false,
      "notes": "MEDIUM. Files: new TonRateLimitException.java, TonCenterBlockchainAdapter.java, TonResilienceConfig.java, TonCenterBlockchainAdapterTest.java"
    },
    {
      "id": "US-012",
      "title": "Add negative tests for TonCenterBlockchainAdapter malformed responses",
      "description": "As a developer, I need the blockchain adapter to handle all malformed responses gracefully.",
      "acceptanceCriteria": [
        "Test in TonCenterBlockchainAdapterTest: response with txId=null — transaction filtered, empty list returned",
        "Test: response with txId.hash=null — transaction filtered",
        "Test: response with inMsg=null — transaction filtered",
        "Test: empty result list — returns empty list, no exception",
        "Test: ok=false response — throws appropriate DomainException",
        "Tests pass"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Test gap. Depends on US-002 being implemented first. File: TonCenterBlockchainAdapterTest.java"
    },
    {
      "id": "US-013",
      "title": "Add idempotency tests for EscrowService duplicate calls",
      "description": "As a developer, I need tests proving duplicate confirmDeposit/releaseEscrow/refundEscrow calls are idempotent.",
      "acceptanceCriteria": [
        "Test in EscrowServiceTest: `confirmDeposit()` called twice with same txHash — `ledgerPort.transfer()` invoked only once (second call is no-op due to idempotency_key)",
        "Test: `releaseEscrow()` called twice with same dealId — `ledgerPort.transfer()` invoked only once",
        "Test: `refundEscrow()` called twice with same dealId — `ledgerPort.transfer()` invoked only once",
        "Mock `ledgerPort.transfer()` to throw `IdempotencyViolationException` on second call, verify EscrowService handles gracefully",
        "Tests pass"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Test gap. File: EscrowServiceTest.java"
    },
    {
      "id": "US-014",
      "title": "Add integration tests for concurrent deposit processing",
      "description": "As a developer, I need integration tests verifying the deposit flow under concurrent load.",
      "acceptanceCriteria": [
        "Create `TonDepositConcurrencyIntegrationTest` in `advert-market-integration-tests` module",
        "Test: two threads call repository `findPendingDeposits()` simultaneously — verify FOR UPDATE SKIP LOCKED prevents overlapping records",
        "Test: two threads call `updateConfirmed()` with same id and version — only one succeeds (CAS)",
        "Use `SharedContainers` singleton for PostgreSQL + Redis (NOT @Container/@Testcontainers)",
        "Use `CountDownLatch` for thread synchronization",
        "Tests pass"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Test gap. Depends on US-001 (CAS fix). File: new TonDepositConcurrencyIntegrationTest.java in advert-market-integration-tests"
    }
  ]
}
