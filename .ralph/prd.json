{
  "project": "advert-market",
  "branchName": "ralph/frontend-visual-overhaul",
  "description": "Frontend visual overhaul: fix text contrast, dark mode fallback, layout overflow, and bring all screens to Telegram Wallet-level quality. Full UI audit with Playwright visual regression tests. Reference: Telegram Wallet (13 screenshots in 'скрины кошелька/').",
  "userStories": [
    {
      "id": "US-001",
      "title": "Define CSS variable fallbacks for non-Telegram environments",
      "description": "App renders invisible text outside Telegram because --tg-theme-* CSS vars are unset. Define complete fallback palette in global.css :root block so dev server, E2E, and web preview always render readable content.",
      "acceptanceCriteria": [
        "Define light theme fallback values in global.css :root for ALL --color-* variables: --color-foreground-primary: #000000, --color-foreground-secondary: #8E8E93, --color-foreground-tertiary: #C7C7CC, --color-background-base: #FFFFFF, --color-background-secondary: #F1F3F4, --color-accent-primary: #3390EC (Telegram Blue), --color-state-success: #34C759, --color-state-destructive: #FF3B30, --color-state-warning: #FF9500, --color-border-separator: rgba(0,0,0,0.08)",
        "Define dark theme fallback via @media (prefers-color-scheme: dark) for non-Telegram: --color-background-base: #1C2C3E, --color-background-secondary: #1C1C1E (Deep Gunmetal OLED), --color-foreground-primary: #FFFFFF, --color-foreground-secondary: #98989F, --color-accent-primary: #3390EC",
        "Support VITE_FORCE_THEME env var: when set to 'dark', apply [data-theme='dark'] on <html> in main.tsx, global.css handles [data-theme='dark'] selector",
        "Fallback values are overridden when Telegram SDK sets --tg-theme-* vars (SDK values take precedence via specificity or variable reassignment)",
        "All --am-* spatial tokens (--am-card-surface, --am-card-border, --am-card-shadow, --am-page-atmosphere, etc.) have fallback values in both light and dark",
        "No pure #000000 used as background anywhere in dark theme (OLED-safe Deep Gunmetal only)",
        "WCAG AA contrast: 4.5:1 for body text, 3:1 for large text (title1+) in both themes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: both light and dark theme render readable text on all pages"
      ],
      "priority": 1,
      "passes": false,
      "notes": "CRITICAL: This unblocks ALL other visual fixes. Without fallbacks, nothing is visible outside Telegram. Files: src/styles/global.css, src/main.tsx (VITE_FORCE_THEME). Do NOT create tailwind.config.ts — project uses Tailwind v4 CSS-first. CSS import order: ui-kit.css -> tailwind.css -> components.css -> global.css."
    },
    {
      "id": "US-002",
      "title": "Fix catalog channel card layout — truncation, alignment, overflow",
      "description": "Channel names overlap language badges and prices. Cards need proper flex layout with text-overflow: ellipsis.",
      "acceptanceCriteria": [
        "Channel name truncates with ellipsis when exceeding available space (flex: 1, min-width: 0, overflow: hidden, text-overflow: ellipsis, white-space: nowrap)",
        "Language badge (RU/EN) is fixed-width, does not shift with name length",
        "VerifiedBadge icon is inline with name, never wraps to next line",
        "Price ('от 5 TON') is right-aligned with flex-shrink: 0, never overlaps name",
        "Subscriber count and @handle are on separate line, fully visible, secondary color",
        "Max 4 data points per card: avatar + name + subscribers + price (per DESIGN_GUIDELINES sec.9)",
        "Avatar letter has proper contrast against colored background",
        "Category chip row scrolls horizontally without layout shift",
        "Summary line ('14 каналов · ...') uses footnote/secondary color",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: catalog page at 390x844, check card layout and text truncation"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Files: src/features/channels/components/ (ChannelListItem or similar), src/pages/catalog/. Use joinClasses() for conditional classes, NOT cn()/clsx. Use <Text> component from @telegram-tools/ui-kit for all text."
    },
    {
      "id": "US-003",
      "title": "Fix deal list card readability — status badges, amounts, hierarchy",
      "description": "Deal status badges are tiny colored bars with invisible text. Need proper pill badges with contrasting text.",
      "acceptanceCriteria": [
        "Status badge uses caption1 (12px) minimum, colored pill background with white text on dark pills, dark text on light pills",
        "Status colors follow deal-status.ts config, visible in both light and dark themes",
        "Deal amount ('3 TON') uses callout typography, right-aligned, clearly visible",
        "Channel name uses body/medium weight, truncates with ellipsis if needed",
        "Date/time uses subheadline2/secondary color, right-aligned below amount",
        "Channel avatar has proper letter contrast",
        "Segment control (Рекламодатель/Владелец) has clear active/inactive states",
        "Empty state for 'no deals' has icon + heading + description + CTA button ('Find a channel' -> /catalog)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: deals list page, check badge readability and amount visibility"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Files: src/features/deals/components/ (DealListItem, DealStatusBadge), src/pages/deals/. Status colors defined in src/features/deals/lib/deal-status.ts."
    },
    {
      "id": "US-004",
      "title": "Fix deal detail page — amount visibility, timeline spacing, action button",
      "description": "Deal amount is invisible, timeline steps float disconnected, action button overlaps content.",
      "acceptanceCriteria": [
        "Deal amount uses title1 bold or title2 bold, high contrast foreground-primary color",
        "Fiat equivalent (~$16.50) uses body/secondary color below amount",
        "Status section has clear background (soft color pill) with readable text",
        "Timeline steps have proper vertical connector lines, consistent spacing",
        "Active timeline step has accent color dot with subtle pulse animation (PulsingDot component)",
        "Completed steps have check icon, pending steps have muted dot",
        "'Ещё N шагов' link is accent-colored, properly spaced",
        "Metadata chips (date, deadline, timer) use consistent chip styling, don't overlap",
        "Comment text uses body weight with 16px padding",
        "Action button ('Отменить') is in FixedBottomBar with proper safe-area-bottom padding",
        "No excessive empty whitespace — content fills viewport or has appropriate footer",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: deal detail page, check amount, timeline, and action button"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Files: src/pages/deals/deal-detail/, src/features/deals/components/ (DealTimeline, MiniTimeline, DealHeader). Use existing PulsingDot from src/shared/ui/components/pulsing-dot.tsx."
    },
    {
      "id": "US-005",
      "title": "Fix wallet page — balance prominence, action buttons, transaction list",
      "description": "Balance is invisible, action button labels are cut off, transaction amounts lack color coding. Must match Telegram Wallet reference quality.",
      "acceptanceCriteria": [
        "Balance uses hero typography (88px) or title1 bold, centered, foreground-primary color, font-variant-numeric: tabular-nums",
        "Fiat equivalent below balance uses body/secondary color",
        "'В эскроу: N TON' is clearly readable with soft accent background badge",
        "Action buttons (Перевод, Пополнить, Вывести, Обменять) have icon above label, equal width, no truncation",
        "Action button icons use size 24, strokeWidth 1.5, accent color (per icon conventions)",
        "Transaction amounts: green (--color-state-success) for income (+), red (--color-state-destructive) for expense (-), with tabular-nums",
        "Transaction type icons are colored circles (matching Telegram Wallet reference): deposit=blue, payout=green, refund=orange, fee=gray",
        "Date group headers ('Сегодня', 'Вчера', '15 января') have section header styling with proper spacing",
        "'Connect Wallet' button is prominent, uses TonConnect brand blue",
        "Crypto/TON segment control has clear active state",
        "Stats cards (В эскроу, Завершённых сделок) have proper card styling with readable numbers",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: wallet page, check balance, action buttons, and transaction list"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Files: src/pages/wallet/, src/features/wallet/components/. Reference: скрины кошелька/ screenshots 1, 5, 9, 10. Use <Text> with type='hero' for balance."
    },
    {
      "id": "US-006",
      "title": "Fix profile page — name visibility, empty state, settings",
      "description": "User name and section headings are invisible. Empty state text blends into card background.",
      "acceptanceCriteria": [
        "User name uses title2 bold, foreground-primary, high contrast",
        "@handle uses body/secondary color",
        "Role badge ('Рекламодатель') has accent soft background with accent text",
        "'Участник с...' uses caption1/tertiary color",
        "Avatar circle has proper border/shadow for depth",
        "'МОИ КАНАЛЫ' section header uses footnote/secondary uppercase",
        "Empty state: icon visible (proper contrast), 'Нет каналов' uses title3 foreground-primary, description uses body/secondary, 'Добавить канал' button is primary",
        "'Мои креативы' GroupItem has chevron, proper icon, readable text",
        "Settings section: 'Язык и валюта' and 'Уведомления' GroupItems have proper icon colors and chevron",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: profile page, check name, empty state, and settings"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Files: src/pages/profile/, src/features/profile/components/. Use <Group> + <GroupItem> from ui-kit for settings sections."
    },
    {
      "id": "US-007",
      "title": "Fix onboarding flow — text visibility, spacing, hierarchy",
      "description": "Titles are clipped/invisible, app name blends into gradient, excessive whitespace on locale step.",
      "acceptanceCriteria": [
        "Step 1 (Язык и валюта): heading uses title2 bold foreground-primary, description uses body/secondary, no excessive top whitespace",
        "Step 2 (Welcome): 'Ad Market' app name uses title1 bold foreground-primary (not blending into gradient)",
        "Feature cards (Каталог каналов, Эскроу TON, Отслеживание сделок) have consistent card styling with icon + title + description",
        "Step 3 (Кто вы?): heading 'Кто вы?' is fully visible, not clipped at viewport top",
        "Role cards have clear selected/unselected states (border accent for selected, default for unselected)",
        "Expanded role details (Находите каналы, etc.) appear with smooth animation",
        "Tour step: channel names in mock catalog are fully visible with proper truncation",
        "Step indicators (dots/progress) have proper accent/tertiary contrast",
        "'Продолжить' button always visible at bottom, not hidden behind content",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: navigate through all onboarding steps, check text visibility at each step"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Files: src/pages/onboarding/, src/features/onboarding/components/. Multiple steps — verify each step renders correctly."
    },
    {
      "id": "US-008",
      "title": "Fix channel detail page — header, stats, pricing tabs",
      "description": "Channel name barely visible in header, stats cards need better contrast, pricing tab amounts hard to read.",
      "acceptanceCriteria": [
        "Channel name uses title2 bold foreground-primary in header",
        "@handle uses body/secondary",
        "VerifiedBadge and language badge inline with name, proper spacing",
        "Category tags (Криптовалюта, Финансы) use chip styling with soft color backgrounds",
        "Stats cards (Подписчики, Средний охват, Вовлечённость) have clear numbers in title2 bold, labels in caption1/secondary",
        "'36% reach' secondary stat is readable in both themes",
        "'Открыть канал в Telegram' row has proper chevron and Telegram icon",
        "Tab bar (О канале / Цены / Правила) has clear active/inactive states with accent underline",
        "Pricing tab: 'от N TON' header uses title2 bold, fiat equivalent in body/secondary",
        "Price cards: post type icon + name + time + CPM on left, amount (title2 bold) + fiat on right",
        "Info buttons have proper tertiary color, don't interfere with tap targets",
        "Share and Edit action buttons in header have proper icon contrast",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: channel detail page with About and Pricing tabs"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Files: src/pages/catalog/channel-detail/, src/features/channels/components/. Navigate to a channel from catalog to verify."
    },
    {
      "id": "US-009",
      "title": "Audit and fix glass blur budget, pressScale, haptic, and tabular-nums",
      "description": "Systematic audit: ensure blur(12px) for cards, blur(20px) for chrome only, atmosphere gradient doesn't kill readability, pressScale on all interactive elements.",
      "acceptanceCriteria": [
        "Audit all AppSurfaceCard usages: confirm backdrop-filter: blur(12px), NOT blur(20px)",
        "Bottom tabs (.am-bottom-tabs): confirm blur(20px)",
        "Atmosphere gradient (AppPageShell::before): verify opacity doesn't reduce text contrast below WCAG AA threshold, adjust opacity if needed",
        "Finance page atmosphere (isFinance variant): slightly stronger glow but still WCAG compliant",
        "All Button, GroupItem onClick, and card onClick have pressScale animation from animations.ts",
        "All card/list item onClick triggers haptic impactOccurred('light') via useHaptic()",
        "All CTA buttons trigger impactOccurred('medium')",
        "All tab/segment switches trigger selectionChanged()",
        "font-variant-numeric: tabular-nums on ALL numeric displays (balance, amounts, prices, stats, dates — per DESIGN_GUIDELINES sec.2)",
        "No blur(20px) on any content card (GPU budget for budget Android)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: spot-check pressScale and tabular-nums on wallet and catalog pages"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Cross-cutting audit. Use Grep to find all blur() usages, all onClick handlers, all numeric displays. Check: AppSurfaceCard, AppPageShell, BottomTabs, all page components. Import pressScale from src/shared/ui/animations.ts. Import useHaptic from src/shared/hooks/use-haptic.ts."
    },
    {
      "id": "US-010",
      "title": "Fix Eruda debug button positioning",
      "description": "Eruda widget overlaps bottom tab bar and interactive elements in bottom-right corner.",
      "acceptanceCriteria": [
        "Eruda entry button does not overlap bottom tabs, FixedBottomBar, or any interactive element",
        "Add CSS override in global.css to reposition eruda-entry to a non-interfering location (e.g., top-right below safe area)",
        "Eruda is hidden in production builds (import.meta.env.PROD)",
        "Eruda is hidden in E2E mode (import.meta.env.MODE === 'e2e') — already done, verify",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: confirm Eruda button does not overlap bottom tabs"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Low priority fix. File: src/styles/global.css (CSS override for .eruda-entry or #eruda), src/main.tsx."
    },
    {
      "id": "US-011",
      "title": "Implement Playwright visual regression test suite",
      "description": "Automated screenshot tests for all main pages in light and dark themes to prevent future visual regression.",
      "acceptanceCriteria": [
        "New test file: e2e/visual-regression.spec.ts",
        "Tests cover: onboarding-locale, onboarding-welcome, onboarding-interest, catalog, channel-detail, channel-prices, deals-list, deal-detail, wallet, profile (10 pages)",
        "Each page tested in both light and dark themes (VITE_FORCE_THEME env var)",
        "Viewport: 390x844 (iPhone 14 Pro)",
        "Screenshot comparison via toHaveScreenshot() with maxDiffPixels tolerance",
        "Test verifies key text elements are present and visible (not empty text content)",
        "Test navigates through MSW-mocked flow (VITE_MOCK_API=true)",
        "Tests pass with initial baseline generation: npx playwright test --update-snapshots",
        "Tests integrated into npm run test:e2e pipeline",
        "Baseline screenshots committed to repo in e2e/__screenshots__/",
        "Typecheck passes",
        "Verify in browser using dev-browser skill: run visual regression tests, confirm all screenshots captured"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Run AFTER all visual fixes are done (US-001 through US-010). Files: new e2e/visual-regression.spec.ts, playwright.config.ts (add project for visual). Use Playwright's built-in screenshot comparison. Existing E2E setup in advert-market-frontend/e2e/."
    }
  ]
}
